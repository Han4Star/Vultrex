<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Repair Business Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-in-left { animation: slideInLeft 0.4s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .hover-grow { transition: all 0.3s ease; }
        .hover-grow:hover { transform: scale(1.05); }
        
        .button-press:active { transform: scale(0.95); }
        
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { transform: scale(1.02); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        
        .stagger-item { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
        .stagger-item:nth-child(1) { animation-delay: 0.1s; }
        .stagger-item:nth-child(2) { animation-delay: 0.2s; }
        .stagger-item:nth-child(3) { animation-delay: 0.3s; }
        .stagger-item:nth-child(4) { animation-delay: 0.4s; }
        .stagger-item:nth-child(5) { animation-delay: 0.5s; }
        .stagger-item:nth-child(6) { animation-delay: 0.6s; }
        .stagger-item:nth-child(7) { animation-delay: 0.7s; }
        .stagger-item:nth-child(8) { animation-delay: 0.8s; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const translations = {
            de: {
                login: 'Anmelden', username: 'Benutzername', password: 'Passwort', loading: 'L√§dt...',
                logout: 'Abmelden', totalBalance: 'Gesamtbilanz', entries: 'Eintr√§ge', history: 'Verlauf',
                categories: 'Handy Modelle', addEntry: 'Eintrag', newEntry: 'Neuer Eintrag',
                income: 'Einnahme', expense: 'Ausgabe', category: 'Kategorie', amount: 'Betrag',
                description: 'Beschreibung', cancel: 'Abbrechen', save: 'Speichern',
                noEntries: 'Keine Eintr√§ge vorhanden', showAll: 'Alle anzeigen',
                settings: 'Einstellungen', language: 'Sprache', theme: 'Design',
                darkMode: 'Dark Mode', lightMode: 'Light Mode', mainPage: 'Hauptseite',
                phoneModel: 'Handy Modell', repairType: 'Reparaturart', price: 'Preis',
                selectPhone: 'Handy w√§hlen', selectRepair: 'Reparatur w√§hlen',
                repairOptions: 'Reparatur Optionen', backToModels: 'Zur√ºck zu Modellen'
            },
            en: {
                login: 'Login', username: 'Username', password: 'Password', loading: 'Loading...',
                logout: 'Logout', totalBalance: 'Total Balance', entries: 'Entries', history: 'History',
                categories: 'Phone Models', addEntry: 'Entry', newEntry: 'New Entry',
                income: 'Income', expense: 'Expense', category: 'Category', amount: 'Amount',
                description: 'Description', cancel: 'Cancel', save: 'Save',
                noEntries: 'No entries available', showAll: 'Show all',
                settings: 'Settings', language: 'Language', theme: 'Theme',
                darkMode: 'Dark Mode', lightMode: 'Light Mode', mainPage: 'Main Page',
                phoneModel: 'Phone Model', repairType: 'Repair Type', price: 'Price',
                selectPhone: 'Select Phone', selectRepair: 'Select Repair',
                repairOptions: 'Repair Options', backToModels: 'Back to Models'
            },
            fr: {
                login: 'Connexion', username: 'Nom d\'utilisateur', password: 'Mot de passe', loading: 'Chargement...',
                logout: 'D√©connexion', totalBalance: 'Solde Total', entries: 'Entr√©es', history: 'Historique',
                categories: 'Mod√®les de t√©l√©phone', addEntry: 'Entr√©e', newEntry: 'Nouvelle Entr√©e',
                income: 'Revenu', expense: 'D√©pense', category: 'Cat√©gorie', amount: 'Montant',
                description: 'Description', cancel: 'Annuler', save: 'Enregistrer',
                noEntries: 'Aucune entr√©e disponible', showAll: 'Tout afficher',
                settings: 'Param√®tres', language: 'Langue', theme: 'Th√®me',
                darkMode: 'Mode Sombre', lightMode: 'Mode Clair', mainPage: 'Page Principale',
                phoneModel: 'Mod√®le de t√©l√©phone', repairType: 'Type de r√©paration', price: 'Prix',
                selectPhone: 'S√©lectionner t√©l√©phone', selectRepair: 'S√©lectionner r√©paration',
                repairOptions: 'Options de r√©paration', backToModels: 'Retour aux mod√®les'
            }
        };

        class App {
            constructor() {
                this.state = {
                    darkMode: true,
                    language: 'de',
                    isLoggedIn: false,
                    username: '',
                    password: '',
                    entries: [],
                    phoneModels: [],
                    repairTypes: [],
                    priceData: {},
                    showAddModal: false,
                    selectedPhone: '',
                    selectedRepair: '',
                    customAmount: '',
                    description: '',
                    type: 'income',
                    loading: false,
                    dataLoading: true,
                    currentUser: '',
                    selectedPhoneModel: null,
                    menuOpen: false,
                    currentPage: 'main',
                    chart: null
                };
                this.init();
            }

            get t() { return translations[this.state.language]; }

            async init() {
                const user = localStorage.getItem('current_user');
                if (user) {
                    this.state.currentUser = user;
                    this.state.isLoggedIn = true;
                    this.loadUserData(user);
                }
                await this.loadGoogleSheetData();
                this.render();
            }

            async loadGoogleSheetData() {
                try {
                    const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHxjp7PpL1exuPsh_iHbg6bjJsFXe98jALeYFJfOVqEKjjHH0IBLXIebKTbn5vKSrLBgLWm4WGpKts/pub?gid=1552836807&single=true&output=csv';
                    
                    const response = await fetch(url);
                    const csvText = await response.text();
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true,
                        complete: (results) => {
                            const data = results.data;
                            
                            // Extract phone models (column headers, skip first column)
                            const headers = Object.keys(data[0]).filter(h => h.trim() !== '');
                            this.state.phoneModels = headers.slice(1);
                            
                            // Extract repair types (first column values)
                            this.state.repairTypes = data.map(row => row[headers[0]]).filter(Boolean);
                            
                            // Build price lookup: priceData[phoneModel][repairType] = price
                            this.state.priceData = {};
                            this.state.phoneModels.forEach(phone => {
                                this.state.priceData[phone] = {};
                            });
                            
                            data.forEach(row => {
                                const repairType = row[headers[0]];
                                if (repairType) {
                                    headers.slice(1).forEach(phone => {
                                        const price = row[phone];
                                        if (price !== undefined && price !== null && price !== '') {
                                            this.state.priceData[phone][repairType] = parseFloat(price);
                                        }
                                    });
                                }
                            });
                            
                            this.state.dataLoading = false;
                            this.render();
                        },
                        error: (error) => {
                            console.error('Error parsing CSV:', error);
                            this.state.dataLoading = false;
                            this.render();
                        }
                    });
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.state.dataLoading = false;
                    this.render();
                }
            }

            loadUserData(user) {
                const entries = localStorage.getItem(`entries_${user}`);
                const settings = localStorage.getItem(`settings_${user}`);
                
                if (entries) this.state.entries = JSON.parse(entries);
                if (settings) {
                    const s = JSON.parse(settings);
                    this.state.darkMode = s.darkMode ?? true;
                    this.state.language = s.language ?? 'de';
                }
            }

            saveSettings() {
                if (this.state.currentUser) {
                    localStorage.setItem(`settings_${this.state.currentUser}`, JSON.stringify({
                        darkMode: this.state.darkMode,
                        language: this.state.language
                    }));
                }
            }

            getRepairsForPhone(phoneModel) {
                if (!this.state.priceData[phoneModel]) return [];
                return Object.entries(this.state.priceData[phoneModel]).map(([repair, price]) => ({
                    repair,
                    price
                }));
            }

            render() {
                const app = document.getElementById('app');
                if (this.state.dataLoading) {
                    app.innerHTML = this.renderLoading();
                } else if (!this.state.isLoggedIn) {
                    app.innerHTML = this.renderLogin();
                } else if (this.state.currentPage === 'settings') {
                    app.innerHTML = this.renderSettings();
                } else {
                    app.innerHTML = this.renderMain();
                    if (this.getChartData().length > 0) this.renderChart();
                }
                this.attachEvents();
            }

            renderLoading() {
                const { darkMode } = this.state;
                return `
                    <div class="min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        <div class="text-center">
                            <div class="animate-pulse-slow text-6xl mb-4">üì±</div>
                            <p class="text-xl ${darkMode ? 'text-white' : 'text-gray-900'}">Lade Preisdaten...</p>
                        </div>
                    </div>
                `;
            }

            renderLogin() {
                const { darkMode } = this.state;
                return `
                    <div class="min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl hover-lift animate-scale-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                            <div class="text-center mb-8">
                                <h1 class="text-4xl font-bold mb-2 animate-pulse-slow ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}">
                                    Phone Repair
                                </h1>
                                <p class="${darkMode ? 'text-gray-400' : 'text-gray-600'}">Business Tracker</p>
                            </div>
                            
                            <div class="space-y-6">
                                <input type="text" id="username" placeholder="${this.t.username}" 
                                    class="w-full px-4 py-3 rounded-xl input-focus outline-none stagger-item ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-white text-gray-900 placeholder-gray-500'}" />
                                
                                <input type="password" id="password" placeholder="${this.t.password}" 
                                    class="w-full px-4 py-3 rounded-xl input-focus outline-none stagger-item ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-white text-gray-900 placeholder-gray-500'}" />
                                
                                <button id="loginBtn" class="w-full py-3 rounded-xl font-semibold button-press stagger-item ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white animate-glow' : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'}">
                                    ${this.state.loading ? this.t.loading : this.t.login}
                                </button>
                            </div>
                        </div>
                        
                        <button id="themeToggle" class="fixed top-8 right-8 p-3 rounded-full hover-grow shadow-lg ${darkMode ? 'bg-gray-800 text-yellow-400' : 'bg-white text-gray-900'}">
                            ${darkMode ? '‚òÄÔ∏è' : 'üåô'}
                        </button>
                    </div>
                `;
            }

            renderSettings() {
                const { darkMode, language } = this.state;
                return `
                    <div class="min-h-screen ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        ${this.renderNav()}
                        ${this.state.menuOpen ? this.renderMenu() : ''}
                        
                        <main class="max-w-3xl mx-auto px-6 py-8">
                            <div class="p-8 rounded-2xl shadow-2xl mb-6 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.theme}</h2>
                                <div class="flex items-center justify-between">
                                    <span class="${darkMode ? 'text-gray-300' : 'text-gray-700'}">${darkMode ? this.t.darkMode : this.t.lightMode}</span>
                                    <button id="darkModeToggle" class="relative w-16 h-8 rounded-full hover-grow ${darkMode ? 'bg-blue-600' : 'bg-gray-300'}">
                                        <div class="absolute top-1 left-1 w-6 h-6 rounded-full bg-white transition-transform duration-300 ${darkMode ? 'translate-x-8' : ''} flex items-center justify-center text-sm">
                                            ${darkMode ? 'üåô' : '‚òÄÔ∏è'}
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <div class="p-8 rounded-2xl shadow-2xl hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.language}</h2>
                                <div class="space-y-4">
                                    ${['de', 'en', 'fr'].map(lang => `
                                        <button data-lang="${lang}" class="w-full px-4 py-3 rounded-xl font-semibold hover-grow button-press ${language === lang ? (darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white') : (darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-100 text-gray-700')}">
                                            ${lang === 'de' ? 'Deutsch' : lang === 'en' ? 'English' : 'Fran√ßais'}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </main>
                    </div>
                `;
            }

            renderNav() {
                const { darkMode, currentUser } = this.state;
                return `
                    <nav class="border-b ${darkMode ? 'bg-gray-900/90 border-gray-800' : 'bg-white/70 border-purple-200'}">
                        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <button id="menuToggle" class="p-2 rounded-lg hover-grow ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900'}">‚ò∞</button>
                                <h1 class="text-2xl font-bold ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}">Phone Repair Tracker</h1>
                            </div>
                            <span class="${darkMode ? 'text-gray-300' : 'text-gray-700'}">${currentUser}</span>
                        </div>
                    </nav>
                `;
            }

            renderMenu() {
                const { darkMode, currentPage } = this.state;
                return `
                    <div class="fixed top-0 left-0 w-64 h-full z-50 animate-slide-in-left shadow-2xl ${darkMode ? 'bg-gray-900 border-r border-gray-800' : 'bg-white border-r border-gray-200'}">
                        <div class="p-6">
                            <button id="menuClose" class="mb-6 p-2 rounded-lg ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600'}">‚úï</button>
                            <div class="space-y-4">
                                <button id="navMain" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${currentPage === 'main' ? (darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900') : (darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100')}">
                                    üè† ${this.t.mainPage}
                                </button>
                                <button id="navSettings" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${currentPage === 'settings' ? (darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900') : (darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100')}">
                                    ‚öôÔ∏è ${this.t.settings}
                                </button>
                                <button id="logoutBtn" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${darkMode ? 'text-red-400 hover:bg-gray-800' : 'text-red-600 hover:bg-gray-100'}">
                                    üö™ ${this.t.logout}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderMain() {
                const { darkMode, selectedPhoneModel, phoneModels } = this.state;
                const total = this.getTotalBalance();
                const filtered = this.getFilteredEntries();

                return `
                    <div class="min-h-screen ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        ${this.renderNav()}
                        ${this.state.menuOpen ? this.renderMenu() : ''}
                        
                        <main class="max-w-7xl mx-auto px-6 py-8">
                            <div class="p-8 rounded-2xl shadow-2xl mb-8 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.totalBalance}</h2>
                                    <div class="animate-bounce">${total >= 0 ? 'üìà' : 'üìâ'}</div>
                                </div>
                                <p class="text-5xl font-bold mb-2 ${total >= 0 ? 'text-green-500' : 'text-red-500'}">${total.toFixed(2)} ‚Ç¨</p>
                                <p class="text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.state.entries.length} ${this.t.entries}</p>
                            </div>

                            ${this.getChartData().length > 0 ? `
                                <div class="p-8 rounded-2xl shadow-2xl mb-8 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                    <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.history}</h2>
                                    <div style="height: 300px;"><canvas id="chart"></canvas></div>
                                </div>
                            ` : ''}

                            <div class="p-8 rounded-2xl shadow-2xl mb-8 ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}">
                                        ${selectedPhoneModel ? `${selectedPhoneModel} - ${this.t.repairOptions}` : this.t.categories}
                                    </h2>
                                    ${selectedPhoneModel ? `
                                        <button id="backToModels" class="px-4 py-2 rounded-xl ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'} hover-grow button-press">
                                            ‚Üê ${this.t.backToModels}
                                        </button>
                                    ` : ''}
                                </div>
                                
                                ${!selectedPhoneModel ? `
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${phoneModels.map(phone => {
                                            const phoneEntries = this.state.entries.filter(e => e.phoneModel === phone);
                                            const phoneTotal = phoneEntries.reduce((sum, e) => sum + e.amount, 0);
                                            return `
                                                <button data-phone="${phone}" class="p-6 rounded-xl hover-lift button-press text-left ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-gray-900'}">
                                                    <div class="text-lg font-semibold mb-2">${phone}</div>
                                                    ${phoneEntries.length > 0 ? `
                                                        <div class="text-2xl font-bold ${phoneTotal >= 0 ? 'text-green-500' : 'text-red-500'} mb-1">
                                                            ${phoneTotal >= 0 ? '+' : ''}${phoneTotal.toFixed(2)} ‚Ç¨
                                                        </div>
                                                        <div class="text-sm opacity-75">${phoneEntries.length} ${this.t.entries}</div>
                                                    ` : `
                                                        <div class="text-sm opacity-75">Keine Eintr√§ge</div>
                                                    `}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${this.getRepairsForPhone(selectedPhoneModel).map(({repair, price}) => `
                                            <button data-repair="${repair}" data-price="${price}" class="p-6 rounded-xl hover-lift button-press text-left ${darkMode ? 'bg-gray-800 hover:bg-gray-700 text-gray-300' : 'bg-white hover:bg-gray-50 text-gray-900'}">
                                                <div class="text-lg font-semibold mb-2">${repair}</div>
                                                <div class="text-2xl font-bold text-blue-500">${price.toFixed(2)} ‚Ç¨</div>
                                            </button>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-8 rounded-2xl shadow-2xl ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}">
                                        ${selectedPhoneModel ? `${selectedPhoneModel} - ${this.t.history}` : this.t.history}
                                    </h2>
                                    ${selectedPhoneModel ? `
                                        <button id="clearFilter" class="text-sm px-3 py-1 rounded-lg ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}">
                                            ${this.t.showAll}
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="space-y-3">
                                    ${filtered.length === 0 ? `
                                        <p class="text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.noEntries}</p>
                                    ` : filtered.slice().reverse().map(e => `
                                        <div class="p-4 rounded-xl hover-lift ${darkMode ? 'bg-gray-800' : 'bg-white/50'}">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <span class="text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-700'}">${e.phoneModel}</span>
                                                        <span class="text-xs px-2 py-1 rounded ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'}">${e.repairType}</span>
                                                    </div>
                                                    <p class="font-medium ${darkMode ? 'text-white' : 'text-gray-900'}">${e.description}</p>
                                                    <p class="text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${e.date}</p>
                                                </div>
                                                <p class="text-xl font-bold ${e.amount >= 0 ? 'text-green-500' : 'text-red-500'}">${e.amount >= 0 ? '+' : ''}${e.amount.toFixed(2)} ‚Ç¨</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </main>

                        ${this.state.showAddModal ? this.renderAddModal() : ''}
                    </div>
                `;
            }

            renderAddModal() {
                const { darkMode, type, phoneModels } = this.state;

                return `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
                        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl animate-scale-in ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-purple-200'}">
                            <h2 class="text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.newEntry}</h2>
                            <div class="space-y-6">
                                <div>
                                    <div class="text-sm mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}">Typ</div>
                                    <div class="flex gap-3">
                                        <button id="typeIncome" class="flex-1 py-3 rounded-xl font-semibold button-press ${type === 'income' ? 'bg-green-600 text-white' : (darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600')}">${this.t.income}</button>
                                        <button id="typeExpense" class="flex-1 py-3 rounded-xl font-semibold button-press ${type === 'expense' ? 'bg-red-600 text-white' : (darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600')}">${this.t.expense}</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.phoneModel}</label>
                                    <select id="phoneSelect" class="w-full px-4 py-3 rounded-xl outline-none ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-900'}">
                                        <option value="">${this.t.selectPhone}</option>
                                        ${phoneModels.map(p => `<option value="${p}">${p}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="repairSelectContainer" style="display: none;">
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.repairType}</label>
                                    <select id="repairSelect" class="w-full px-4 py-3 rounded-xl outline-none ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-900'}">
                                        <option value="">${this.t.selectRepair}</option>
                                    </select>
                                </div>
                                <div id="priceDisplay" style="display: none;" class="p-4 rounded-xl ${darkMode ? 'bg-blue-900/30 border border-blue-800' : 'bg-blue-50 border border-blue-200'}">
                                    <div class="text-sm ${darkMode ? 'text-blue-300' : 'text-blue-700'} mb-1">${this.t.price}</div>
                                    <div id="priceValue" class="text-2xl font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}">0.00 ‚Ç¨</div>
                                </div>
                                <div>
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.description}</label>
                                    <input type="text" id="entryDesc" placeholder="z.B. iPhone 12 Display Reparatur" class="w-full px-4 py-3 rounded-xl input-focus outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}" />
                                </div>
                                <div class="flex gap-3 pt-4">
                                    <button id="cancelEntry" class="flex-1 py-3 rounded-xl font-semibold button-press ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-900'}">${this.t.cancel}</button>
                                    <button id="saveEntry" class="flex-1 py-3 rounded-xl font-semibold bg-blue-600 hover:bg-blue-700 text-white button-press">${this.t.save}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getTotalBalance() {
                return this.state.entries.reduce((sum, e) => sum + e.amount, 0);
            }

            getChartData() {
                const sortedEntries = [...this.state.entries].sort((a, b) => a.timestamp - b.timestamp);
                return sortedEntries.map((entry, index) => {
                    const runningTotal = sortedEntries.slice(0, index + 1).reduce((sum, e) => sum + e.amount, 0);
                    return { date: entry.date, balance: runningTotal };
                });
            }

            getFilteredEntries() {
                return this.state.selectedPhoneModel 
                    ? this.state.entries.filter(e => e.phoneModel === this.state.selectedPhoneModel)
                    : this.state.entries;
            }

            renderChart() {
                setTimeout(() => {
                    const canvas = document.getElementById('chart');
                    if (!canvas) return;
                    if (this.state.chart) this.state.chart.destroy();

                    const data = this.getChartData();
                    const ctx = canvas.getContext('2d');

                    this.state.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.date),
                            datasets: [{
                                label: this.t.totalBalance,
                                data: data.map(d => d.balance),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                pointBackgroundColor: data.map(d => d.balance >= 0 ? '#10b981' : '#ef4444'),
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: this.state.darkMode ? '#111827' : '#ffffff',
                                    titleColor: this.state.darkMode ? '#fff' : '#000',
                                    bodyColor: this.state.darkMode ? '#fff' : '#000',
                                    borderColor: this.state.darkMode ? '#374151' : '#a855f7',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: false,
                                    callbacks: { 
                                        label: (ctx) => `Bilanz: ${ctx.parsed.y.toFixed(2)} ‚Ç¨` 
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    grid: { color: this.state.darkMode ? '#1f2937' : '#e5e7eb' },
                                    ticks: {
                                        color: this.state.darkMode ? '#6b7280' : '#6b7280',
                                        callback: (val) => `${val} ‚Ç¨`
                                    }
                                },
                                x: {
                                    grid: { color: this.state.darkMode ? '#1f2937' : '#e5e7eb' },
                                    ticks: { color: this.state.darkMode ? '#6b7280' : '#6b7280' }
                                }
                            },
                            animation: { duration: 1000, easing: 'easeInOutQuart' }
                        }
                    });
                }, 100);
            }

            attachEvents() {
                // Login
                const loginBtn = document.getElementById('loginBtn');
                const username = document.getElementById('username');
                const password = document.getElementById('password');
                
                if (loginBtn) {
                    loginBtn.onclick = () => {
                        this.state.username = username.value;
                        this.state.password = password.value;
                        this.state.loading = true;
                        this.render();
                        
                        setTimeout(() => {
                            const userKey = `user_${this.state.username}`;
                            const stored = localStorage.getItem(userKey);
                            
                            if (!stored) {
                                localStorage.setItem(userKey, this.state.password);
                                localStorage.setItem('current_user', this.state.username);
                                this.state.currentUser = this.state.username;
                                this.state.isLoggedIn = true;
                            } else if (stored === this.state.password) {
                                localStorage.setItem('current_user', this.state.username);
                                this.state.currentUser = this.state.username;
                                this.state.isLoggedIn = true;
                                this.loadUserData(this.state.username);
                            } else {
                                alert('Falsches Passwort!');
                            }
                            
                            this.state.loading = false;
                            this.render();
                        }, 500);
                    };
                }

                // Theme Toggle
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.onclick = () => {
                        this.state.darkMode = !this.state.darkMode;
                        this.saveSettings();
                        this.render();
                    };
                }

                // Dark Mode Toggle
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.onclick = () => {
                        this.state.darkMode = !this.state.darkMode;
                        this.saveSettings();
                        this.render();
                    };
                }

                // Language buttons
                document.querySelectorAll('[data-lang]').forEach(btn => {
                    btn.onclick = () => {
                        this.state.language = btn.dataset.lang;
                        this.saveSettings();
                        this.render();
                    };
                });

                // Menu
                const menuToggle = document.getElementById('menuToggle');
                const menuClose = document.getElementById('menuClose');
                if (menuToggle) menuToggle.onclick = () => { this.state.menuOpen = true; this.render(); };
                if (menuClose) menuClose.onclick = () => { this.state.menuOpen = false; this.render(); };

                // Navigation
                const navMain = document.getElementById('navMain');
                const navSettings = document.getElementById('navSettings');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (navMain) navMain.onclick = () => { this.state.currentPage = 'main'; this.state.menuOpen = false; this.render(); };
                if (navSettings) navSettings.onclick = () => { this.state.currentPage = 'settings'; this.state.menuOpen = false; this.render(); };
                if (logoutBtn) {
                    logoutBtn.onclick = () => {
                        localStorage.removeItem('current_user');
                        this.state.isLoggedIn = false;
                        this.state.currentUser = '';
                        this.state.entries = [];
                        this.state.menuOpen = false;
                        this.render();
                    };
                }

                // Phone model selection (main view)
                document.querySelectorAll('[data-phone]').forEach(btn => {
                    btn.onclick = () => {
                        this.state.selectedPhoneModel = btn.dataset.phone;
                        this.render();
                    };
                });

                // Back to models
                const backToModels = document.getElementById('backToModels');
                if (backToModels) {
                    backToModels.onclick = () => {
                        this.state.selectedPhoneModel = null;
                        this.render();
                    };
                }

                // Clear filter
                const clearFilter = document.getElementById('clearFilter');
                if (clearFilter) {
                    clearFilter.onclick = () => { 
                        this.state.selectedPhoneModel = null; 
                        this.render(); 
                    };
                }

                // Repair selection buttons (when phone is selected)
                document.querySelectorAll('[data-repair]').forEach(btn => {
                    btn.onclick = () => {
                        const repair = btn.dataset.repair;
                        const price = parseFloat(btn.dataset.price);
                        
                        // Open modal with pre-filled data
                        this.state.selectedPhone = this.state.selectedPhoneModel;
                        this.state.selectedRepair = repair;
                        this.state.customAmount = price;
                        this.state.showAddModal = true;
                        this.render();
                    };
                });

                // Modal - Type selection
                const typeIncome = document.getElementById('typeIncome');
                const typeExpense = document.getElementById('typeExpense');
                if (typeIncome) typeIncome.onclick = () => { this.state.type = 'income'; this.render(); };
                if (typeExpense) typeExpense.onclick = () => { this.state.type = 'expense'; this.render(); };

                // Modal - Phone selection
                const phoneSelect = document.getElementById('phoneSelect');
                if (phoneSelect) {
                    // Pre-select if coming from repair button
                    if (this.state.selectedPhone) {
                        phoneSelect.value = this.state.selectedPhone;
                        this.updateRepairOptions();
                    }
                    
                    phoneSelect.onchange = () => {
                        this.state.selectedPhone = phoneSelect.value;
                        this.updateRepairOptions();
                    };
                }

                // Modal - Repair selection
                const repairSelect = document.getElementById('repairSelect');
                if (repairSelect) {
                    // Pre-select if coming from repair button
                    if (this.state.selectedRepair) {
                        repairSelect.value = this.state.selectedRepair;
                        this.updatePrice();
                    }
                    
                    repairSelect.onchange = () => {
                        this.state.selectedRepair = repairSelect.value;
                        this.updatePrice();
                    };
                }

                // Modal - Cancel
                const cancelEntry = document.getElementById('cancelEntry');
                if (cancelEntry) {
                    cancelEntry.onclick = () => { 
                        this.state.showAddModal = false;
                        this.state.selectedPhone = '';
                        this.state.selectedRepair = '';
                        this.state.customAmount = '';
                        this.render(); 
                    };
                }

                // Modal - Save
                const saveEntry = document.getElementById('saveEntry');
                const entryDesc = document.getElementById('entryDesc');
                
                if (saveEntry && entryDesc) {
                    saveEntry.onclick = () => {
                        const phoneSelect = document.getElementById('phoneSelect');
                        const repairSelect = document.getElementById('repairSelect');
                        
                        if (!phoneSelect.value || !repairSelect.value || !entryDesc.value) {
                            alert('Bitte alle Felder ausf√ºllen!');
                            return;
                        }
                        
                        const price = this.state.priceData[phoneSelect.value][repairSelect.value] || 0;
                        
                        if (price === 0) {
                            alert('Preis nicht gefunden!');
                            return;
                        }
                        
                        const newEntry = {
                            id: Date.now(),
                            amount: this.state.type === 'expense' ? -Math.abs(price) : Math.abs(price),
                            description: entryDesc.value,
                            phoneModel: phoneSelect.value,
                            repairType: repairSelect.value,
                            type: this.state.type,
                            date: new Date().toLocaleDateString(this.state.language === 'de' ? 'de-DE' : this.state.language === 'fr' ? 'fr-FR' : 'en-US'),
                            timestamp: Date.now()
                        };

                        this.state.entries.push(newEntry);
                        localStorage.setItem(`entries_${this.state.currentUser}`, JSON.stringify(this.state.entries));
                        this.state.showAddModal = false;
                        this.state.selectedPhone = '';
                        this.state.selectedRepair = '';
                        this.state.customAmount = '';
                        this.render();
                    };
                }
            }

            updateRepairOptions() {
                const phoneSelect = document.getElementById('phoneSelect');
                const repairSelect = document.getElementById('repairSelect');
                const repairContainer = document.getElementById('repairSelectContainer');
                
                if (!phoneSelect || !repairSelect || !repairContainer) return;
                
                if (phoneSelect.value) {
                    repairContainer.style.display = 'block';
                    const repairs = this.getRepairsForPhone(phoneSelect.value);
                    
                    repairSelect.innerHTML = `<option value="">${this.t.selectRepair}</option>` +
                        repairs.map(({repair}) => `<option value="${repair}">${repair}</option>`).join('');
                    
                    // If repair was pre-selected, select it
                    if (this.state.selectedRepair) {
                        repairSelect.value = this.state.selectedRepair;
                        this.updatePrice();
                    }
                } else {
                    repairContainer.style.display = 'none';
                    document.getElementById('priceDisplay').style.display = 'none';
                }
            }

            updatePrice() {
                const phoneSelect = document.getElementById('phoneSelect');
                const repairSelect = document.getElementById('repairSelect');
                const priceDisplay = document.getElementById('priceDisplay');
                const priceValue = document.getElementById('priceValue');
                
                if (!phoneSelect || !repairSelect || !priceDisplay || !priceValue) return;
                
                if (phoneSelect.value && repairSelect.value) {
                    const price = this.state.priceData[phoneSelect.value][repairSelect.value] || 0;
                    priceValue.textContent = `${price.toFixed(2)} ‚Ç¨`;
                    priceDisplay.style.display = 'block';
                } else {
                    priceDisplay.style.display = 'none';
                }
            }
        }

        // Start App
        new App();
    </script>
</body>
</html>
