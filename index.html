import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { Moon, Sun, Plus, LogOut, TrendingUp, TrendingDown, ChevronRight, Menu, X, Settings, Home, Trash2 } from 'lucide-react';

const translations = {
  de: {
    login: 'Anmelden',
    username: 'Benutzername',
    password: 'Passwort',
    loading: 'Lädt...',
    logout: 'Abmelden',
    totalBalance: 'Gesamtbilanz',
    entries: 'Einträge',
    history: 'Verlauf',
    categories: 'Kategorien',
    addEntry: 'Eintrag',
    newEntry: 'Neuer Eintrag',
    income: 'Einnahme',
    expense: 'Ausgabe',
    category: 'Kategorie',
    amount: 'Betrag',
    description: 'Beschreibung',
    cancel: 'Abbrechen',
    save: 'Speichern',
    noEntries: 'Keine Einträge vorhanden',
    showAll: 'Alle anzeigen',
    settings: 'Einstellungen',
    language: 'Sprache',
    theme: 'Design',
    darkMode: 'Dark Mode',
    lightMode: 'Light Mode',
    mainPage: 'Hauptseite',
    newCategory: 'Neue Kategorie',
    categoryName: 'Kategoriename',
    addCategory: 'Kategorie hinzufügen',
    deleteCategory: 'Löschen'
  },
  en: {
    login: 'Login',
    username: 'Username',
    password: 'Password',
    loading: 'Loading...',
    logout: 'Logout',
    totalBalance: 'Total Balance',
    entries: 'Entries',
    history: 'History',
    categories: 'Categories',
    addEntry: 'Entry',
    newEntry: 'New Entry',
    income: 'Income',
    expense: 'Expense',
    category: 'Category',
    amount: 'Amount',
    description: 'Description',
    cancel: 'Cancel',
    save: 'Save',
    noEntries: 'No entries available',
    showAll: 'Show all',
    settings: 'Settings',
    language: 'Language',
    theme: 'Theme',
    darkMode: 'Dark Mode',
    lightMode: 'Light Mode',
    mainPage: 'Main Page',
    newCategory: 'New Category',
    categoryName: 'Category Name',
    addCategory: 'Add Category',
    deleteCategory: 'Delete'
  },
  fr: {
    login: 'Connexion',
    username: 'Nom d\'utilisateur',
    password: 'Mot de passe',
    loading: 'Chargement...',
    logout: 'Déconnexion',
    totalBalance: 'Solde Total',
    entries: 'Entrées',
    history: 'Historique',
    categories: 'Catégories',
    addEntry: 'Entrée',
    newEntry: 'Nouvelle Entrée',
    income: 'Revenu',
    expense: 'Dépense',
    category: 'Catégorie',
    amount: 'Montant',
    description: 'Description',
    cancel: 'Annuler',
    save: 'Enregistrer',
    noEntries: 'Aucune entrée disponible',
    showAll: 'Tout afficher',
    settings: 'Paramètres',
    language: 'Langue',
    theme: 'Thème',
    darkMode: 'Mode Sombre',
    lightMode: 'Mode Clair',
    mainPage: 'Page Principale',
    newCategory: 'Nouvelle Catégorie',
    categoryName: 'Nom de la catégorie',
    addCategory: 'Ajouter une catégorie',
    deleteCategory: 'Supprimer'
  }
};

export default function PhoneRepairTracker() {
  const [darkMode, setDarkMode] = useState(true);
  const [language, setLanguage] = useState('de');
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [entries, setEntries] = useState([]);
  const [categories, setCategories] = useState([]);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showCategoryModal, setShowCategoryModal] = useState(false);
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  const [category, setCategory] = useState('');
  const [newCategoryName, setNewCategoryName] = useState('');
  const [type, setType] = useState('income');
  const [loading, setLoading] = useState(false);
  const [currentUser, setCurrentUser] = useState('');
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [menuOpen, setMenuOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState('main');

  const t = translations[language];

  useEffect(() => {
    checkLoginStatus();
  }, []);

  useEffect(() => {
    if (categories.length > 0) {
      setCategory(categories[0]);
    }
  }, [categories]);

  const checkLoginStatus = async () => {
    try {
      const result = await window.storage.get('current_user');
      if (result) {
        setCurrentUser(result.value);
        setIsLoggedIn(true);
        await loadUserData(result.value);
      }
    } catch (error) {
      console.log('No user logged in');
    }
  };

  const loadUserData = async (user) => {
    try {
      const entriesResult = await window.storage.get(`entries_${user}`);
      if (entriesResult) {
        setEntries(JSON.parse(entriesResult.value));
      }
    } catch (error) {
      setEntries([]);
    }

    try {
      const categoriesResult = await window.storage.get(`categories_${user}`);
      if (categoriesResult) {
        setCategories(JSON.parse(categoriesResult.value));
      }
    } catch (error) {
      setCategories([]);
    }

    try {
      const settingsResult = await window.storage.get(`settings_${user}`);
      if (settingsResult) {
        const settings = JSON.parse(settingsResult.value);
        setDarkMode(settings.darkMode ?? true);
        setLanguage(settings.language ?? 'de');
      }
    } catch (error) {
      setDarkMode(true);
      setLanguage('de');
    }
  };

  const saveSettings = async () => {
    try {
      await window.storage.set(`settings_${currentUser}`, JSON.stringify({
        darkMode,
        language
      }));
    } catch (error) {
      console.error('Settings save error:', error);
    }
  };

  useEffect(() => {
    if (currentUser) {
      saveSettings();
    }
  }, [darkMode, language]);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      const userKey = `user_${username}`;
      let storedPassword;
      
      try {
        const result = await window.storage.get(userKey);
        storedPassword = result ? result.value : null;
      } catch (error) {
        storedPassword = null;
      }

      if (!storedPassword) {
        await window.storage.set(userKey, password);
        await window.storage.set('current_user', username);
        setCurrentUser(username);
        setIsLoggedIn(true);
        setEntries([]);
        setCategories([]);
      } else if (storedPassword === password) {
        await window.storage.set('current_user', username);
        setCurrentUser(username);
        setIsLoggedIn(true);
        await loadUserData(username);
      } else {
        alert('Falsches Passwort!');
      }
    } catch (error) {
      alert('Login fehlgeschlagen');
    }
    
    setLoading(false);
  };

  const handleLogout = async () => {
    try {
      await window.storage.delete('current_user');
      setIsLoggedIn(false);
      setCurrentUser('');
      setEntries([]);
      setCategories([]);
      setUsername('');
      setPassword('');
      setMenuOpen(false);
      setCurrentPage('main');
    } catch (error) {
      console.error('Logout error:', error);
    }
  };

  const handleAddCategory = async (e) => {
    e.preventDefault();
    if (!newCategoryName.trim()) return;

    const updatedCategories = [...categories, newCategoryName.trim()];
    setCategories(updatedCategories);
    
    try {
      await window.storage.set(`categories_${currentUser}`, JSON.stringify(updatedCategories));
    } catch (error) {
      console.error('Save error:', error);
    }

    setNewCategoryName('');
    setShowCategoryModal(false);
  };

  const handleDeleteCategory = async (catToDelete) => {
    const updatedCategories = categories.filter(c => c !== catToDelete);
    setCategories(updatedCategories);
    
    try {
      await window.storage.set(`categories_${currentUser}`, JSON.stringify(updatedCategories));
    } catch (error) {
      console.error('Save error:', error);
    }
  };

  const handleAddEntry = async (e) => {
    e.preventDefault();
    const newEntry = {
      id: Date.now(),
      amount: type === 'expense' ? -Math.abs(parseFloat(amount)) : Math.abs(parseFloat(amount)),
      description,
      category,
      type,
      date: new Date().toLocaleDateString(language === 'de' ? 'de-DE' : language === 'fr' ? 'fr-FR' : 'en-US'),
      timestamp: Date.now()
    };

    const updatedEntries = [...entries, newEntry];
    setEntries(updatedEntries);
    
    try {
      await window.storage.set(`entries_${currentUser}`, JSON.stringify(updatedEntries));
    } catch (error) {
      console.error('Save error:', error);
    }

    setAmount('');
    setDescription('');
    setShowAddModal(false);
  };

  const totalBalance = entries.reduce((sum, entry) => sum + entry.amount, 0);
  const chartData = entries.map((entry, index) => {
    const runningTotal = entries.slice(0, index + 1).reduce((sum, e) => sum + e.amount, 0);
    return {
      date: entry.date,
      balance: runningTotal
    };
  });

  const getCategoryStats = () => {
    const stats = {};
    entries.forEach(entry => {
      if (!stats[entry.category]) {
        stats[entry.category] = { total: 0, count: 0 };
      }
      stats[entry.category].total += entry.amount;
      stats[entry.category].count += 1;
    });
    return stats;
  };

  const categoryStats = getCategoryStats();
  const filteredEntries = selectedCategory 
    ? entries.filter(e => e.category === selectedCategory)
    : entries;

  if (!isLoggedIn) {
    return (
      <div className={`min-h-screen flex items-center justify-center transition-all duration-500 ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}`}>
        <div className={`w-full max-w-md p-8 rounded-2xl backdrop-blur-lg shadow-2xl transform transition-all duration-500 hover:scale-105 ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
          <div className="text-center mb-8">
            <h1 className={`text-4xl font-bold mb-2 ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}`}>
              Phone Repair
            </h1>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Business Tracker</p>
          </div>
          
          <div className="space-y-6">
            <input
              type="text"
              placeholder={t.username}
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-white/50 text-gray-900 placeholder-gray-500'}`}
            />
            
            <input
              type="password"
              placeholder={t.password}
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-white/50 text-gray-900 placeholder-gray-500'}`}
            />
            
            <button
              onClick={handleLogin}
              disabled={loading}
              className={`w-full py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'} ${loading ? 'opacity-50' : ''}`}
            >
              {loading ? t.loading : t.login}
            </button>
          </div>
        </div>
        
        <button
          onClick={() => setDarkMode(!darkMode)}
          className={`fixed top-8 right-8 p-3 rounded-full transition-all duration-300 hover:scale-110 ${darkMode ? 'bg-gray-800 text-yellow-400' : 'bg-white text-gray-900'} shadow-lg`}
        >
          {darkMode ? <Sun size={24} /> : <Moon size={24} />}
        </button>
      </div>
    );
  }

  if (currentPage === 'settings') {
    return (
      <div className={`min-h-screen transition-all duration-500 ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}`}>
        <nav className={`backdrop-blur-lg border-b transition-all duration-300 ${darkMode ? 'bg-gray-900/90 border-gray-800' : 'bg-white/70 border-purple-200'}`}>
          <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div className="flex items-center gap-4">
              <button
                onClick={() => setMenuOpen(!menuOpen)}
                className={`p-2 rounded-lg transition-all duration-300 hover:scale-110 ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900'}`}
              >
                <Menu size={24} />
              </button>
              <h1 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}`}>
                {t.settings}
              </h1>
            </div>
          </div>
        </nav>

        {menuOpen && (
          <div className={`fixed top-0 left-0 w-64 h-full z-50 transition-transform duration-300 ${darkMode ? 'bg-gray-900 border-r border-gray-800' : 'bg-white border-r border-gray-200'} shadow-2xl`}>
            <div className="p-6">
              <button
                onClick={() => setMenuOpen(false)}
                className={`mb-6 p-2 rounded-lg ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'}`}
              >
                <X size={24} />
              </button>

              <div className="space-y-4">
                <button
                  onClick={() => { setCurrentPage('main'); setMenuOpen(false); }}
                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'}`}
                >
                  <Home size={20} />
                  {t.mainPage}
                </button>

                <button
                  onClick={() => { setCurrentPage('settings'); setMenuOpen(false); }}
                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900'}`}
                >
                  <Settings size={20} />
                  {t.settings}
                </button>

                <button
                  onClick={handleLogout}
                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${darkMode ? 'text-red-400 hover:bg-gray-800' : 'text-red-600 hover:bg-gray-100'}`}
                >
                  <LogOut size={20} />
                  {t.logout}
                </button>
              </div>
            </div>
          </div>
        )}

        <main className="max-w-3xl mx-auto px-6 py-8">
          <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl mb-6 ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
            <h2 className={`text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>{t.theme}</h2>
            
            <div className="flex items-center justify-between">
              <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{darkMode ? t.darkMode : t.lightMode}</span>
              
              <button
                onClick={() => setDarkMode(!darkMode)}
                className={`relative w-16 h-8 rounded-full transition-all duration-300 ${darkMode ? 'bg-blue-600' : 'bg-gray-300'}`}
              >
                <div className={`absolute top-1 left-1 w-6 h-6 rounded-full bg-white transition-transform duration-300 ${darkMode ? 'translate-x-8' : 'translate-x-0'} flex items-center justify-center`}>
                  {darkMode ? <Moon size={14} /> : <Sun size={14} />}
                </div>
              </button>
            </div>
          </div>

          <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
            <h2 className={`text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>{t.language}</h2>
            
            <div className="space-y-4">
              {[
                { code: 'de', name: 'Deutsch' },
                { code: 'en', name: 'English' },
                { code: 'fr', name: 'Français' }
              ].map(lang => (
                <button
                  key={lang.code}
                  onClick={() => setLanguage(lang.code)}
                  className={`w-full px-4 py-3 rounded-xl font-semibold transition-all duration-300 ${
                    language === lang.code
                      ? darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  {lang.name}
                </button>
              ))}
            </div>
          </div>
        </main>
      </div>
    );
  }

  return (
    <div className={`min-h-screen transition-all duration-500 ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}`}>
      <nav className={`backdrop-blur-lg border-b transition-all duration-300 ${darkMode ? 'bg-gray-900/90 border-gray-800' : 'bg-white/70 border-purple-200'}`}>
        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
          <div className="flex items-center gap-4">
            <button
              onClick={() => setMenuOpen(!menuOpen)}
              className={`p-2 rounded-lg transition-all duration-300 hover:scale-110 ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900'}`}
            >
              <Menu size={24} />
            </button>
            <h1 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}`}>
              Phone Repair Tracker
            </h1>
          </div>
          
          <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{currentUser}</span>
        </div>
      </nav>

      {menuOpen && (
        <div className={`fixed top-0 left-0 w-64 h-full z-50 transition-transform duration-300 ${darkMode ? 'bg-gray-900 border-r border-gray-800' : 'bg-white border-r border-gray-200'} shadow-2xl`}>
          <div className="p-6">
            <button
              onClick={() => setMenuOpen(false)}
              className={`mb-6 p-2 rounded-lg ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'}`}
            >
              <X size={24} />
            </button>

            <div className="space-y-4">
              <button
                onClick={() => { setCurrentPage('main'); setMenuOpen(false); }}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900'}`}
              >
                <Home size={20} />
                {t.mainPage}
              </button>

              <button
                onClick={() => { setCurrentPage('settings'); setMenuOpen(false); }}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'}`}
              >
                <Settings size={20} />
                {t.settings}
              </button>

              <button
                onClick={handleLogout}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${darkMode ? 'text-red-400 hover:bg-gray-800' : 'text-red-600 hover:bg-gray-100'}`}
              >
                <LogOut size={20} />
                {t.logout}
              </button>
            </div>
          </div>
        </div>
      )}

      <main className="max-w-7xl mx-auto px-6 py-8">
        <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl mb-8 transform transition-all duration-500 hover:scale-[1.02] ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
          <div className="flex items-center justify-between mb-4">
            <h2 className={`text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{t.totalBalance}</h2>
            {totalBalance >= 0 ? (
              <TrendingUp className="text-green-500 animate-bounce" size={24} />
            ) : (
              <TrendingDown className="text-red-500 animate-bounce" size={24} />
            )}
          </div>
          
          <p className={`text-5xl font-bold mb-2 ${totalBalance >= 0 ? 'text-green-500' : 'text-red-500'}`}>
            {totalBalance.toFixed(2)} €
          </p>
          
          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            {entries.length} {t.entries}
          </p>
        </div>

        {chartData.length > 0 && (
          <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl mb-8 transform transition-all duration-500 hover:scale-[1.02] ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
            <h2 className={`text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>{t.history}</h2>
            
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" stroke={darkMode ? '#1f2937' : '#e5e7eb'} />
                <XAxis dataKey="date" stroke={darkMode ? '#6b7280' : '#6b7280'} />
                <YAxis stroke={darkMode ? '#6b7280' : '#6b7280'} />
                <Tooltip 
                  contentStyle={{
                    backgroundColor: darkMode ? '#111827' : '#ffffff',
                    border: `1px solid ${darkMode ? '#374151' : '#a855f7'}`,
                    borderRadius: '12px',
                    color: darkMode ? '#fff' : '#000'
                  }}
                />
                <defs>
                  <linearGradient id="colorGradient" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stopColor="#10b981" />
                    <stop offset="50%" stopColor="#3b82f6" />
                    <stop offset="100%" stopColor="#ef4444" />
                  </linearGradient>
                </defs>
                <Line 
                  type="monotone" 
                  dataKey="balance" 
                  stroke="url(#colorGradient)"
                  strokeWidth={3}
                  dot={(props) => {
                    const { cx, cy, payload } = props;
                    return (
                      <circle
                        cx={cx}
                        cy={cy}
                        r={5}
                        fill={payload.balance >= 0 ? '#10b981' : '#ef4444'}
                      />
                    );
                  }}
                  activeDot={{ r: 8 }}
                />
              </LineChart>
            </ResponsiveContainer>
          </div>
        )}

        <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl mb-8 ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
          <div className="flex justify-between items-center mb-6">
            <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{t.categories}</h2>
            <button
              onClick={() => setShowCategoryModal(true)}
              className="flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-all duration-300 transform hover:scale-105"
            >
              <Plus size={20} />
              {t.newCategory}
            </button>
          </div>
          
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {categories.map((cat) => (
              <div key={cat} className="relative group">
                <button
                  onClick={() => setSelectedCategory(selectedCategory === cat ? null : cat)}
                  className={`w-full p-4 rounded-xl transition-all duration-300 hover:scale-105 ${
                    selectedCategory === cat 
                      ? darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-gray-900'
                  }`}
                >
                  <div className="text-sm mb-1">{cat}</div>
                  {categoryStats[cat] && (
                    <>
                      <div className={`text-lg font-bold ${categoryStats[cat].total >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                        {categoryStats[cat].total >= 0 ? '+' : ''}{categoryStats[cat].total.toFixed(2)} €
                      </div>
                      <div className="text-xs opacity-75">{categoryStats[cat].count} {t.entries}</div>
                    </>
                  )}
                </button>
                <button
                  onClick={() => handleDeleteCategory(cat)}
                  className={`absolute top-2 right-2 p-1 rounded opacity-0 group-hover:opacity-100 transition-all ${darkMode ? 'bg-red-500 text-white' : 'bg-red-500 text-white'}`}
                >
                  <Trash2 size={14} />
                </button>
              </div>
            ))}
          </div>
        </div>

        <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
          <div className="flex justify-between items-center mb-6">
            <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              {selectedCategory ? `${selectedCategory} - ${t.history}` : t.history}
            </h2>
            
            {selectedCategory && (
              <button
                onClick={() => setSelectedCategory(null)}
                className={`text-sm px-3 py-1 rounded-lg ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}`}
              >
                {t.showAll}
              </button>
            )}
            
            <button
              onClick={() => setShowAddModal(true)}
              disabled={categories.length === 0}
              className={`flex items-center gap-2 px-4 py-2 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 ${
                categories.length === 0 
                  ? 'bg-gray-500 text-gray-300 cursor-not-allowed'
                  : 'bg-blue-600 hover:bg-blue-700 text-white hover:shadow-lg'
              }`}
            >
              <Plus size={20} />
              {t.addEntry}
            </button>
          </div>

          <div className="space-y-3">
            {filteredEntries.length === 0 ? (
              <p className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                {t.noEntries}
              </p>
            ) : (
              filteredEntries.slice().reverse().map((entry) => (
                <div
                  key={entry.id}
                  onClick={() => setSelectedCategory(entry.category)}
                  className={`p-4 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:shadow-lg cursor-pointer ${darkMode ? 'bg-gray-800' : 'bg-white/50'}`}
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>
                          {entry.category}
                        </span>
                        <ChevronRight size={14} className={darkMode ? 'text-gray-500' : 'text-gray-400'} />
                      </div>
                      <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {entry.description}
                      </p>
                      <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        {entry.date}
                      </p>
                    </div>
                    
                    <p className={`text-xl font-bold ${entry.amount >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                      {entry.amount >= 0 ? '+' : ''}{entry.amount.toFixed(2)} €
                    </p>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </main>

      {showCategoryModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className={`w-full max-w-md p-8 rounded-2xl shadow-2xl ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-purple-200'}`}>
            <h2 className={`text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              {t.newCategory}
            </h2>
            
            <div className="space-y-6">
              <input
                type="text"
                placeholder={t.categoryName}
                value={newCategoryName}
                onChange={(e) => setNewCategoryName(e.target.value)}
                className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}`}
              />
              
              <div className="flex gap-3">
                <button
                  onClick={() => setShowCategoryModal(false)}
                  className={`flex-1 py-3 rounded-xl font-semibold transition-all duration-300 hover:scale-105 ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-900'}`}
                >
                  {t.cancel}
                </button>
                
                <button
                  onClick={handleAddCategory}
                  className="flex-1 py-3 rounded-xl font-semibold bg-blue-600 hover:bg-blue-700 text-white transition-all duration-300 hover:scale-105"
                >
                  {t.addCategory}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {showAddModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className={`w-full max-w-md p-8 rounded-2xl shadow-2xl ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-purple-200'}`}>
            <h2 className={`text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              {t.newEntry}
            </h2>
            
            <div className="space-y-6">
              <div>
                <div className={`text-sm mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Typ</div>
                <div className="flex gap-3">
                  <button
                    onClick={() => setType('income')}
                    className={`flex-1 py-3 rounded-xl font-semibold transition-all duration-300 ${
                      type === 'income'
                        ? 'bg-green-600 text-white scale-105'
                        : darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'
                    }`}
                  >
                    {t.income}
                  </button>
                  <button
                    onClick={() => setType('expense')}
                    className={`flex-1 py-3 rounded-xl font-semibold transition-all duration-300 ${
                      type === 'expense'
                        ? 'bg-red-600 text-white scale-105'
                        : darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600'
                    }`}
                  >
                    {t.expense}
                  </button>
                </div>
              </div>

              <div>
                <label className={`text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{t.category}</label>
                <select
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-900'}`}
                >
                  {categories.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className={`text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{t.amount} (€)</label>
                <input
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  value={amount}
                  onChange={(e) => setAmount(e.target.value)}
                  className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}`}
                />
              </div>
              
              <div>
                <label className={`text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{t.description}</label>
                <input
                  type="text"
                  placeholder="z.B. Display Reparatur"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}`}
                />
              </div>
              
              <div className="flex gap-3 pt-4">
                <button
                  onClick={() => setShowAddModal(false)}
                  className={`flex-1 py-3 rounded-xl font-semibold transition-all duration-300 hover:scale-105 ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-900'}`}
                >
                  {t.cancel}
                </button>
                
                <button
                  onClick={handleAddEntry}
                  className="flex-1 py-3 rounded-xl font-semibold bg-blue-600 hover:bg-blue-700 text-white transition-all duration-300 hover:scale-105"
                >
                  {t.save}
