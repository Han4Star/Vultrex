<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handy-Reparatur Dashboard</title>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .btn-device {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-device:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
            display: none;
        }

        .modal.active {
            display: flex;
        }

        .loader {
            border-top-color: #3b82f6;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .positive { color: #10b981; }
        .negative { color: #ef4444; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <p class="text-gray-600 font-medium">Daten werden geladen...</p>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- Header / Total Balance -->
        <header class="text-center mb-10">
            <h1 class="text-gray-500 uppercase tracking-widest text-sm font-bold mb-2">Finanz-Dashboard</h1>
            <div class="glass-card inline-block px-10 py-6">
                <p class="text-gray-600 text-lg">Gesamt-Endstand</p>
                <div class="text-5xl md:text-6xl font-black text-blue-600" id="total-balance">0,00 €</div>
            </div>
        </header>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            <div class="lg:col-span-2 glass-card p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Kumulierter Verlauf</h2>
                <div class="h-64">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            <div class="glass-card p-6 flex flex-col justify-center items-center text-center">
                <h2 class="text-xl font-bold mb-2 text-gray-800">Statistik</h2>
                <div class="w-full space-y-4">
                    <div class="bg-green-50 p-4 rounded-xl">
                        <p class="text-green-600 text-xs font-bold uppercase">Einnahmen</p>
                        <p id="total-income" class="text-2xl font-bold text-green-700">0 €</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl">
                        <p class="text-red-600 text-xs font-bold uppercase">Ausgaben</p>
                        <p id="total-expense" class="text-2xl font-bold text-red-700">0 €</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Grid -->
        <h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-blue-500 pl-4">Geräte & Kategorien</h2>
        <div id="device-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Buttons will be injected here -->
        </div>
    </div>

    <!-- Details Modal -->
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <table class="w-full text-left">
                    <thead class="text-xs uppercase text-gray-500 font-bold border-b">
                        <tr>
                            <th class="pb-2">Datum</th>
                            <th class="pb-2">Kategorie</th>
                            <th class="pb-2 text-right">Preis</th>
                        </tr>
                    </thead>
                    <tbody id="modal-body" class="text-sm divide-y">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 bg-gray-50 text-right border-t">
                <button onclick="closeModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition">Schließen</button>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHxjp7PpL1exuPsh_iHbg6bjJsFXe98jALeYFJfOVqEKjjHH0IBLXIebKTbn5vKSrLBgLWm4WGpKts/pub?output=csv';
        
        let rawData = [];
        let deviceGroups = {};
        let myChart = null;

        // Initialize App
        window.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        async function fetchData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    processData(results.data);
                    document.getElementById('loading-overlay').style.display = 'none';
                },
                error: function(err) {
                    console.error("Fehler beim Laden der CSV:", err);
                    alert("Daten konnten nicht geladen werden.");
                }
            });
        }

        function processData(data) {
            // Filter invalid rows
            rawData = data.filter(row => row['Zeitstempel'] && row['Welches Handy?']);
            
            let total = 0;
            let income = 0;
            let expense = 0;
            deviceGroups = {};

            // Sorting by date for chart
            const sortedData = [...rawData].sort((a, b) => new Date(a['Zeitstempel']) - new Date(b['Zeitstempel']));

            const chartLabels = [];
            const chartValues = [];
            let runningTotal = 0;

            rawData.forEach(row => {
                const price = parseFloat(String(row['Preis']).replace(',', '.')) || 0;
                total += price;
                if(price > 0) income += price;
                else expense += Math.abs(price);

                const device = row['Welches Handy?'];
                if (!deviceGroups[device]) deviceGroups[device] = [];
                deviceGroups[device].push(row);
            });

            sortedData.forEach(row => {
                const price = parseFloat(String(row['Preis']).replace(',', '.')) || 0;
                runningTotal += price;
                chartLabels.push(new Date(row['Zeitstempel']).toLocaleDateString('de-DE'));
                chartValues.push(runningTotal);
            });

            animateValue("total-balance", 0, total, 1500);
            document.getElementById('total-income').innerText = income.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
            document.getElementById('total-expense').innerText = expense.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });

            renderButtons();
            renderChart(chartLabels, chartValues);
        }

        function renderButtons() {
            const grid = document.getElementById('device-grid');
            grid.innerHTML = '';

            Object.keys(deviceGroups).sort().forEach(deviceName => {
                const transactions = deviceGroups[deviceName];
                const deviceBalance = transactions.reduce((sum, row) => sum + (parseFloat(String(row['Preis']).replace(',', '.')) || 0), 0);
                
                const btn = document.createElement('button');
                btn.className = 'btn-device glass-card p-5 text-left border border-transparent hover:border-blue-300';
                btn.onclick = () => showDetails(deviceName);
                
                btn.innerHTML = `
                    <div class="text-xs font-bold text-gray-400 uppercase mb-1 truncate">${deviceName}</div>
                    <div class="text-xl font-bold ${deviceBalance >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${deviceBalance.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })}
                    </div>
                    <div class="text-xs text-gray-500 mt-2">${transactions.length} Transaktion(en)</div>
                `;
                grid.appendChild(btn);
            });
        }

        function renderChart(labels, values) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kontostand Verlauf (€)',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#e5e7eb' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function showDetails(deviceName) {
            const transactions = deviceGroups[deviceName];
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.innerText = deviceName;
            body.innerHTML = '';

            transactions.sort((a,b) => new Date(b['Zeitstempel']) - new Date(a['Zeitstempel'])).forEach(tr => {
                const price = parseFloat(String(tr['Preis']).replace(',', '.')) || 0;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 text-gray-600">${new Date(tr['Zeitstempel']).toLocaleDateString('de-DE')}</td>
                    <td class="py-3 font-medium text-gray-800">${tr['Kategorie']}</td>
                    <td class="py-3 text-right font-bold ${price >= 0 ? 'positive' : 'negative'}">
                        ${price.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })}
                    </td>
                `;
                body.appendChild(row);
            });

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / (range || 1)));
            
            // Limit speed for large numbers
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const value = start + (range * progress);
                
                obj.innerHTML = value.toLocaleString('de-DE', { 
                    style: 'currency', 
                    currency: 'EUR',
                    minimumFractionDigits: 2 
                });

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) closeModal();
        }
    </script>
</body>
</html>

