import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { Moon, Sun, Plus, LogOut, TrendingUp, TrendingDown, ChevronRight } from 'lucide-react';

const CATEGORIES = [
  'iPhone X', 'iPhone 11', 'iPhone 12', 'iPhone 13', 'iPhone 14', 'iPhone 15',
  'Samsung Galaxy', 'iPad', 'Display', 'Batterie', 'Kamera', 'Sonstiges'
];

export default function PhoneRepairTracker() {
  const [darkMode, setDarkMode] = useState(true);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [entries, setEntries] = useState([]);
  const [showAddModal, setShowAddModal] = useState(false);
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  const [category, setCategory] = useState(CATEGORIES[0]);
  const [type, setType] = useState('income'); // 'income' or 'expense'
  const [loading, setLoading] = useState(false);
  const [currentUser, setCurrentUser] = useState('');
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [isDragging, setIsDragging] = useState(false);
  const [dragPosition, setDragPosition] = useState(0);

  useEffect(() => {
    checkLoginStatus();
  }, []);

  const checkLoginStatus = async () => {
    try {
      const result = await window.storage.get('current_user');
      if (result) {
        setCurrentUser(result.value);
        setIsLoggedIn(true);
        await loadEntries(result.value);
      }
    } catch (error) {
      console.log('No user logged in');
    }
  };

  const loadEntries = async (user) => {
    try {
      const result = await window.storage.get(`entries_${user}`);
      if (result) {
        setEntries(JSON.parse(result.value));
      }
    } catch (error) {
      setEntries([]);
    }
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      const userKey = `user_${username}`;
      let storedPassword;
      
      try {
        const result = await window.storage.get(userKey);
        storedPassword = result ? result.value : null;
      } catch (error) {
        storedPassword = null;
      }

      if (!storedPassword) {
        await window.storage.set(userKey, password);
        await window.storage.set('current_user', username);
        setCurrentUser(username);
        setIsLoggedIn(true);
        setEntries([]);
      } else if (storedPassword === password) {
        await window.storage.set('current_user', username);
        setCurrentUser(username);
        setIsLoggedIn(true);
        await loadEntries(username);
      } else {
        alert('Falsches Passwort!');
      }
    } catch (error) {
      alert('Login fehlgeschlagen');
    }
    
    setLoading(false);
  };

  const handleLogout = async () => {
    try {
      await window.storage.delete('current_user');
      setIsLoggedIn(false);
      setCurrentUser('');
      setEntries([]);
      setUsername('');
      setPassword('');
    } catch (error) {
      console.error('Logout error:', error);
    }
  };

  const handleAddEntry = async (e) => {
    e.preventDefault();
    const newEntry = {
      id: Date.now(),
      amount: type === 'expense' ? -Math.abs(parseFloat(amount)) : Math.abs(parseFloat(amount)),
      description,
      category,
      type,
      date: new Date().toLocaleDateString('de-DE'),
      timestamp: Date.now()
    };

    const updatedEntries = [...entries, newEntry];
    setEntries(updatedEntries);
    
    try {
      await window.storage.set(`entries_${currentUser}`, JSON.stringify(updatedEntries));
    } catch (error) {
      console.error('Save error:', error);
    }

    setAmount('');
    setDescription('');
    setShowAddModal(false);
  };

  const handleMouseDown = (e) => {
    setIsDragging(true);
    updatePosition(e.clientX);
  };

  const handleMouseMove = (e) => {
    if (isDragging) {
      updatePosition(e.clientX);
    }
  };

  const handleMouseUp = () => {
    setIsDragging(false);
    setType(dragPosition > 50 ? 'expense' : 'income');
    setDragPosition(dragPosition > 50 ? 100 : 0);
  };

  const handleTouchStart = (e) => {
    setIsDragging(true);
    updatePosition(e.touches[0].clientX);
  };

  const handleTouchMove = (e) => {
    if (isDragging) {
      updatePosition(e.touches[0].clientX);
    }
  };

  const handleTouchEnd = () => {
    setIsDragging(false);
    setType(dragPosition > 50 ? 'expense' : 'income');
    setDragPosition(dragPosition > 50 ? 100 : 0);
  };

  const updatePosition = (clientX) => {
    const container = document.getElementById('switch-container');
    if (container) {
      const rect = container.getBoundingClientRect();
      const x = clientX - rect.left;
      const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
      setDragPosition(percentage);
    }
  };

  useEffect(() => {
    if (!isDragging) {
      setDragPosition(type === 'expense' ? 100 : 0);
    }
  }, [type, isDragging]);

  const totalBalance = entries.reduce((sum, entry) => sum + entry.amount, 0);
  const chartData = entries.map((entry, index) => {
    const runningTotal = entries.slice(0, index + 1).reduce((sum, e) => sum + e.amount, 0);
    return {
      date: entry.date,
      balance: runningTotal
    };
  });

  const getCategoryStats = () => {
    const stats = {};
    entries.forEach(entry => {
      if (!stats[entry.category]) {
        stats[entry.category] = { total: 0, count: 0 };
      }
      stats[entry.category].total += entry.amount;
      stats[entry.category].count += 1;
    });
    return stats;
  };

  const categoryStats = getCategoryStats();
  const filteredEntries = selectedCategory 
    ? entries.filter(e => e.category === selectedCategory)
    : entries;

  if (!isLoggedIn) {
    return (
      <div className={`min-h-screen flex items-center justify-center transition-all duration-500 ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}`}>
        <div className={`w-full max-w-md p-8 rounded-2xl backdrop-blur-lg shadow-2xl transform transition-all duration-500 hover:scale-105 ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
          <div className="text-center mb-8 animate-fade-in">
            <h1 className={`text-4xl font-bold mb-2 ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}`}>
              Phone Repair
            </h1>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Business Tracker</p>
          </div>
          
          <div className="space-y-6" onSubmit={handleLogin}>
            <div className="transform transition-all duration-300 hover:translate-x-1">
              <input
                type="text"
                placeholder="Benutzername"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-white/50 text-gray-900 placeholder-gray-500'}`}
                required
              />
            </div>
            
            <div className="transform transition-all duration-300 hover:translate-x-1">
              <input
                type="password"
                placeholder="Passwort"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-white/50 text-gray-900 placeholder-gray-500'}`}
                required
              />
            </div>
            
            <button
              onClick={handleLogin}
              disabled={loading}
              className={`w-full py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 hover:shadow-lg ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'} ${loading ? 'opacity-50' : ''}`}
            >
              {loading ? 'Lädt...' : 'Anmelden'}
            </button>
          </div>
        </div>
        
        <button
          onClick={() => setDarkMode(!darkMode)}
          className={`fixed top-8 right-8 p-3 rounded-full transition-all duration-300 hover:scale-110 ${darkMode ? 'bg-gray-800 text-yellow-400' : 'bg-white text-gray-900'} shadow-lg`}
        >
          {darkMode ? <Sun size={24} /> : <Moon size={24} />}
        </button>
      </div>
    );
  }

  return (
    <div className={`min-h-screen transition-all duration-500 ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}`}>
      <nav className={`backdrop-blur-lg border-b transition-all duration-300 ${darkMode ? 'bg-gray-900/90 border-gray-800' : 'bg-white/70 border-purple-200'}`}>
        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
          <h1 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}`}>
            Phone Repair Tracker
          </h1>
          
          <div className="flex items-center gap-4">
            <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{currentUser}</span>
            
            <button
              onClick={() => setDarkMode(!darkMode)}
              className={`p-2 rounded-lg transition-all duration-300 hover:scale-110 ${darkMode ? 'bg-gray-800 text-yellow-400' : 'bg-gray-100 text-gray-900'}`}
            >
              {darkMode ? <Sun size={20} /> : <Moon size={20} />}
            </button>
            
            <button
              onClick={handleLogout}
              className={`p-2 rounded-lg transition-all duration-300 hover:scale-110 ${darkMode ? 'bg-gray-800 text-red-400' : 'bg-gray-100 text-red-600'}`}
            >
              <LogOut size={20} />
            </button>
          </div>
        </div>
      </nav>

      <main className="max-w-7xl mx-auto px-6 py-8">
        <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl mb-8 transform transition-all duration-500 hover:scale-[1.02] ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
          <div className="flex items-center justify-between mb-4">
            <h2 className={`text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Gesamtbilanz</h2>
            {totalBalance >= 0 ? (
              <TrendingUp className="text-green-500 animate-bounce" size={24} />
            ) : (
              <TrendingDown className="text-red-500 animate-bounce" size={24} />
            )}
          </div>
          
          <p className={`text-5xl font-bold mb-2 ${totalBalance >= 0 ? 'text-green-500' : 'text-red-500'}`}>
            {totalBalance.toFixed(2)} €
          </p>
          
          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            {entries.length} Einträge
          </p>
        </div>

        {chartData.length > 0 && (
          <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl mb-8 transform transition-all duration-500 hover:scale-[1.02] ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
            <h2 className={`text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Verlauf</h2>
            
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" stroke={darkMode ? '#1f2937' : '#e5e7eb'} />
                <XAxis dataKey="date" stroke={darkMode ? '#6b7280' : '#6b7280'} />
                <YAxis stroke={darkMode ? '#6b7280' : '#6b7280'} />
                <Tooltip 
                  contentStyle={{
                    backgroundColor: darkMode ? '#111827' : '#ffffff',
                    border: `1px solid ${darkMode ? '#374151' : '#a855f7'}`,
                    borderRadius: '12px',
                    color: darkMode ? '#fff' : '#000'
                  }}
                />
                <Line 
                  type="monotone" 
                  dataKey="balance" 
                  stroke="#3b82f6" 
                  strokeWidth={3}
                  dot={{ fill: '#3b82f6', r: 5 }}
                  activeDot={{ r: 8, className: 'animate-pulse' }}
                />
              </LineChart>
            </ResponsiveContainer>
          </div>
        )}

        <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl mb-8 ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
          <h2 className={`text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Kategorien</h2>
          
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {Object.entries(categoryStats).map(([cat, stats]) => (
              <button
                key={cat}
                onClick={() => setSelectedCategory(selectedCategory === cat ? null : cat)}
                className={`p-4 rounded-xl transition-all duration-300 hover:scale-105 ${
                  selectedCategory === cat 
                    ? darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                    : darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-gray-900'
                }`}
              >
                <div className="text-sm mb-1">{cat}</div>
                <div className={`text-lg font-bold ${stats.total >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                  {stats.total >= 0 ? '+' : ''}{stats.total.toFixed(2)} €
                </div>
                <div className="text-xs opacity-75">{stats.count} Einträge</div>
              </button>
            ))}
          </div>
        </div>

        <div className={`p-8 rounded-2xl backdrop-blur-lg shadow-2xl transform transition-all duration-500 hover:scale-[1.02] ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}`}>
          <div className="flex justify-between items-center mb-6">
            <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              {selectedCategory ? `${selectedCategory} - Historie` : 'Historie'}
            </h2>
            
            {selectedCategory && (
              <button
                onClick={() => setSelectedCategory(null)}
                className={`text-sm px-3 py-1 rounded-lg ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}`}
              >
                Alle anzeigen
              </button>
            )}
            
            <button
              onClick={() => setShowAddModal(true)}
              className="flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-all duration-300 transform hover:scale-105 hover:shadow-lg"
            >
              <Plus size={20} />
              Eintrag
            </button>
          </div>

          <div className="space-y-3">
            {filteredEntries.length === 0 ? (
              <p className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Keine Einträge vorhanden
              </p>
            ) : (
              filteredEntries.slice().reverse().map((entry, index) => (
                <div
                  key={entry.id}
                  onClick={() => setSelectedCategory(entry.category)}
                  className={`p-4 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:shadow-lg cursor-pointer ${darkMode ? 'bg-gray-800' : 'bg-white/50'}`}
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>
                          {entry.category}
                        </span>
                        <ChevronRight size={14} className={darkMode ? 'text-gray-500' : 'text-gray-400'} />
                      </div>
                      <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {entry.description}
                      </p>
                      <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        {entry.date}
                      </p>
                    </div>
                    
                    <p className={`text-xl font-bold ${entry.amount >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                      {entry.amount >= 0 ? '+' : ''}{entry.amount.toFixed(2)} €
                    </p>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </main>

      {showAddModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className={`w-full max-w-md p-8 rounded-2xl shadow-2xl transform transition-all duration-500 scale-100 ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-purple-200'}`}>
            <h2 className={`text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              Neuer Eintrag
            </h2>
            
            <div className="space-y-6">
              {/* Liquid Toggle Switch */}
              <div>
                <div className={`text-sm mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Typ</div>
                <div 
                  id="switch-container"
                  className={`relative h-14 rounded-2xl overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                  onMouseMove={handleMouseMove}
                  onMouseUp={handleMouseUp}
                  onMouseLeave={handleMouseUp}
                  onTouchMove={handleTouchMove}
                  onTouchEnd={handleTouchEnd}
                >
                  <div className="absolute inset-0 flex">
                    <button
                      type="button"
                      onClick={() => setType('income')}
                      className={`flex-1 z-10 font-semibold transition-colors duration-300 ${type === 'income' ? 'text-white' : darkMode ? 'text-gray-400' : 'text-gray-600'}`}
                    >
                      Einnahme
                    </button>
                    <button
                      type="button"
                      onClick={() => setType('expense')}
                      className={`flex-1 z-10 font-semibold transition-colors duration-300 ${type === 'expense' ? 'text-white' : darkMode ? 'text-gray-400' : 'text-gray-600'}`}
                    >
                      Ausgabe
                    </button>
                  </div>
                  
                  <div 
                    className="absolute top-1 bottom-1 w-1/2 rounded-xl transition-all duration-300 ease-out"
                    style={{
                      left: `${dragPosition}%`,
                      transform: `translateX(-50%) scale(${isDragging ? 1.05 : 1})`,
                      background: type === 'income' ? '#10b981' : '#ef4444',
                      boxShadow: isDragging 
                        ? '0 8px 32px rgba(0,0,0,0.3), inset 0 -2px 8px rgba(255,255,255,0.2)'
                        : '0 4px 16px rgba(0,0,0,0.2), inset 0 -1px 4px rgba(255,255,255,0.15)',
                      filter: isDragging ? 'blur(0.5px)' : 'none'
                    }}
                    onMouseDown={handleMouseDown}
                    onTouchStart={handleTouchStart}
                  />
                </div>
              </div>

              <div>
                <label className={`text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Kategorie</label>
                <select
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-900'}`}
                >
                  {CATEGORIES.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className={`text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Betrag (€)</label>
                <input
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  value={amount}
                  onChange={(e) => setAmount(e.target.value)}
                  className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}`}
                  required
                />
              </div>
              
              <div>
                <label className={`text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Beschreibung</label>
                <input
                  type="text"
                  placeholder="z.B. Display Reparatur"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  className={`w-full px-4 py-3 rounded-xl transition-all duration-300 focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}`}
                  required
                />
              </div>
              
              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={() => setShowAddModal(false)}
                  className={`flex-1 py-3 rounded-xl font-semibold transition-all duration-300 hover:scale-105 ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-900'}`}
                >
                  Abbrechen
                </button>
                
                <button
                  onClick={handleAddEntry}
                  className="flex-1 py-3 rounded-xl font-semibold bg-blue-600 hover:bg-blue-700 text-white transition-all duration-300 hover:scale-105 hover:shadow-lg"
                >
                  Speichern
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
