<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Repair Business Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8); }
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-in-left { animation: slideInLeft 0.4s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .hover-grow { transition: all 0.3s ease; }
        .hover-grow:hover { transform: scale(1.05); }
        
        .button-press:active { transform: scale(0.95); }
        
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { transform: scale(1.02); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        
        .stagger-item { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
        .stagger-item:nth-child(1) { animation-delay: 0.1s; }
        .stagger-item:nth-child(2) { animation-delay: 0.2s; }
        .stagger-item:nth-child(3) { animation-delay: 0.3s; }
        .stagger-item:nth-child(4) { animation-delay: 0.4s; }
        .stagger-item:nth-child(5) { animation-delay: 0.5s; }
        .stagger-item:nth-child(6) { animation-delay: 0.6s; }
        .stagger-item:nth-child(7) { animation-delay: 0.7s; }
        .stagger-item:nth-child(8) { animation-delay: 0.8s; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const SUPABASE_URL = 'https://jpwnhsblrmizqwvwnfsb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd25oc2Jscm1penF3dnduZnNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5OTE0NTYsImV4cCI6MjA4MzU2NzQ1Nn0.03F1ppRXNf9upk3tI4W84EQH8pNMmQCdbEPxsNixcuY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const translations = {
            de: {
                loginWithDiscord: 'Mit Discord anmelden', logout: 'Abmelden', totalBalance: 'Gesamtbilanz', 
                entries: 'Eintr√§ge', history: 'Verlauf', categories: 'Kategorien', addEntry: 'Eintrag', 
                newEntry: 'Neuer Eintrag', income: 'Einnahme', expense: 'Ausgabe', category: 'Kategorie', 
                amount: 'Betrag', description: 'Beschreibung', cancel: 'Abbrechen', save: 'Speichern',
                noEntries: 'Keine Eintr√§ge vorhanden', showAll: 'Alle anzeigen', settings: 'Einstellungen', 
                language: 'Sprache', theme: 'Design', darkMode: 'Dark Mode', lightMode: 'Light Mode', 
                mainPage: 'Hauptseite', newCategory: 'Neue Kategorie', categoryName: 'Kategoriename',
                addCategory: 'Kategorie hinzuf√ºgen', loading: 'L√§dt...'
            },
            en: {
                loginWithDiscord: 'Login with Discord', logout: 'Logout', totalBalance: 'Total Balance',
                entries: 'Entries', history: 'History', categories: 'Categories', addEntry: 'Entry',
                newEntry: 'New Entry', income: 'Income', expense: 'Expense', category: 'Category',
                amount: 'Amount', description: 'Description', cancel: 'Cancel', save: 'Save',
                noEntries: 'No entries available', showAll: 'Show all', settings: 'Settings',
                language: 'Language', theme: 'Theme', darkMode: 'Dark Mode', lightMode: 'Light Mode',
                mainPage: 'Main Page', newCategory: 'New Category', categoryName: 'Category Name',
                addCategory: 'Add Category', loading: 'Loading...'
            },
            fr: {
                loginWithDiscord: 'Connexion avec Discord', logout: 'D√©connexion', totalBalance: 'Solde Total',
                entries: 'Entr√©es', history: 'Historique', categories: 'Cat√©gories', addEntry: 'Entr√©e',
                newEntry: 'Nouvelle Entr√©e', income: 'Revenu', expense: 'D√©pense', category: 'Cat√©gorie',
                amount: 'Montant', description: 'Description', cancel: 'Annuler', save: 'Enregistrer',
                noEntries: 'Aucune entr√©e disponible', showAll: 'Tout afficher', settings: 'Param√®tres',
                language: 'Langue', theme: 'Th√®me', darkMode: 'Mode Sombre', lightMode: 'Mode Clair',
                mainPage: 'Page Principale', newCategory: 'Nouvelle Cat√©gorie', categoryName: 'Nom de la cat√©gorie',
                addCategory: 'Ajouter une cat√©gorie', loading: 'Chargement...'
            }
        };

        class App {
            constructor() {
                this.state = {
                    darkMode: true, language: 'de', isLoggedIn: false, entries: [], categories: [],
                    showAddModal: false, showCategoryModal: false, amount: '', description: '',
                    category: '', newCategoryName: '', type: 'income', loading: false, currentUser: '',
                    userId: null, selectedCategory: null, menuOpen: false, currentPage: 'main',
                    chart: null, isSaving: false
                };
                this.init();
            }

            get t() { return translations[this.state.language]; }

            async init() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    this.state.currentUser = session.user.user_metadata?.full_name || session.user.email;
                    this.state.userId = session.user.id;
                    this.state.isLoggedIn = true;
                    await this.loadUserData(session.user.id);
                    
                    // Auto-invite zu Discord Server (nur beim ersten Login)
                    const { data: settings } = await supabaseClient
                        .from('settings')
                        .select('discord_invited')
                        .eq('user_id', session.user.id)
                        .single();
                    
                    if (!settings || !settings.discord_invited) {
                        await this.inviteToDiscord(session.user.id);
                    }
                } else {
                    const localSettings = localStorage.getItem('app_settings');
                    if (localSettings) {
                        const s = JSON.parse(localSettings);
                        this.state.darkMode = s.darkMode ?? true;
                        this.state.language = s.language ?? 'de';
                    }
                }
                this.render();
            }

            async inviteToDiscord(userId) {
                try {
                    await fetch(`${SUPABASE_URL}/functions/v1/discord-invite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({ user_id: userId })
                    });
                    
                    // Markiere als eingeladen
                    await supabaseClient.from('settings').upsert({
                        user_id: userId,
                        discord_invited: true
                    });
                } catch (error) {
                    console.log('Discord invite error:', error);
                }
            }

            async loadUserData(userId) {
                this.state.loading = true;
                
                try {
                    const { data: entries, error: entriesError } = await supabaseClient
                        .from('entries')
                        .select('*')
                        .eq('user_id', userId)
                        .order('timestamp', { ascending: true });

                    const { data: categories, error: categoriesError } = await supabaseClient
                        .from('categories')
                        .select('*')
                        .eq('user_id', userId);

                    const { data: settings } = await supabaseClient
                        .from('settings')
                        .select('*')
                        .eq('user_id', userId)
                        .single();

                    if (entries) this.state.entries = entries;
                    
                    if (categories && !categoriesError) {
                        this.state.categories = categories.map(c => c.name);
                    } else {
                        // Falls Datenbank nicht verf√ºgbar, nutze lokalen Speicher
                        console.log('Lade Kategorien aus lokalem Speicher');
                        this.loadCategoriesFromLocal();
                    }
                    
                    if (settings) {
                        this.state.darkMode = settings.dark_mode ?? true;
                        this.state.language = settings.language ?? 'de';
                    }
                } catch (error) {
                    console.error('Fehler beim Laden:', error);
                    this.loadCategoriesFromLocal();
                }
                
                this.state.loading = false;
            }

            saveSettings() {
                localStorage.setItem('app_settings', JSON.stringify({
                    darkMode: this.state.darkMode,
                    language: this.state.language
                }));
                
                if (this.state.userId) {
                    supabaseClient.from('settings').upsert({
                        user_id: this.state.userId,
                        dark_mode: this.state.darkMode,
                        language: this.state.language
                    });
                }
            }

            saveCategoriesToLocal() {
                localStorage.setItem('categories_' + this.state.userId, JSON.stringify(this.state.categories));
            }

            loadCategoriesFromLocal() {
                const saved = localStorage.getItem('categories_' + this.state.userId);
                if (saved) {
                    this.state.categories = JSON.parse(saved);
                }
            }

            async loginWithDiscord() {
                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'discord',
                    options: {
                        redirectTo: window.location.origin,
                        scopes: 'identify email guilds.join'
                    }
                });
                if (error) alert(error.message);
            }

            render() {
                const app = document.getElementById('app');
                if (!this.state.isLoggedIn) {
                    app.innerHTML = this.renderLogin();
                } else if (this.state.currentPage === 'settings') {
                    app.innerHTML = this.renderSettings();
                } else {
                    app.innerHTML = this.renderMain();
                    if (this.getChartData().length > 0) this.renderChart();
                }
                this.attachEvents();
            }

            renderLogin() {
                const { darkMode } = this.state;
                return `
                    <div class="min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl hover-lift animate-scale-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                            <div class="text-center mb-8">
                                <h1 class="text-4xl font-bold mb-2 animate-pulse-slow ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}">
                                    Phone Repair
                                </h1>
                                <p class="${darkMode ? 'text-gray-400' : 'text-gray-600'}">Cloud Business Tracker</p>
                            </div>
                            
                            <button id="discordLoginBtn" class="w-full py-4 px-6 rounded-xl font-semibold button-press flex items-center justify-center gap-3 bg-indigo-600 hover:bg-indigo-700 text-white transition-all duration-300 hover:scale-105 animate-glow">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                                </svg>
                                ${this.t.loginWithDiscord}
                            </button>
                        </div>
                        
                        <button id="themeToggle" class="fixed top-8 right-8 p-3 rounded-full hover-grow shadow-lg ${darkMode ? 'bg-gray-800 text-yellow-400' : 'bg-white text-gray-900'}">
                            ${darkMode ? '‚òÄÔ∏è' : 'üåô'}
                        </button>
                    </div>
                `;
            }

            renderSettings() {
                const { darkMode, language } = this.state;
                return `
                    <div class="min-h-screen ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        ${this.renderNav()}
                        ${this.state.menuOpen ? this.renderMenu() : ''}
                        
                        <main class="max-w-3xl mx-auto px-6 py-8">
                            <div class="p-8 rounded-2xl shadow-2xl mb-6 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.theme}</h2>
                                <div class="flex items-center justify-between">
                                    <span class="${darkMode ? 'text-gray-300' : 'text-gray-700'}">${darkMode ? this.t.darkMode : this.t.lightMode}</span>
                                    <button id="darkModeToggle" class="relative w-16 h-8 rounded-full hover-grow ${darkMode ? 'bg-blue-600' : 'bg-gray-300'}">
                                        <div class="absolute top-1 left-1 w-6 h-6 rounded-full bg-white transition-transform duration-300 ${darkMode ? 'translate-x-8' : ''} flex items-center justify-center text-sm">
                                            ${darkMode ? 'üåô' : '‚òÄÔ∏è'}
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <div class="p-8 rounded-2xl shadow-2xl hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.language}</h2>
                                <div class="space-y-4">
                                    ${['de', 'en', 'fr'].map(lang => `
                                        <button data-lang="${lang}" class="w-full px-4 py-3 rounded-xl font-semibold hover-grow button-press ${language === lang ? (darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white') : (darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-100 text-gray-700')}">
                                            ${lang === 'de' ? 'Deutsch' : lang === 'en' ? 'English' : 'Fran√ßais'}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </main>
                    </div>
                `;
            }

            renderNav() {
                const { darkMode, currentUser } = this.state;
                return `
                    <nav class="border-b ${darkMode ? 'bg-gray-900/90 border-gray-800' : 'bg-white/70 border-purple-200'}">
                        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <button id="menuToggle" class="p-2 rounded-lg hover-grow ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900'}">‚ò∞</button>
                                <h1 class="text-2xl font-bold ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}">Phone Repair Tracker</h1>
                            </div>
                            <span class="${darkMode ? 'text-gray-300' : 'text-gray-700'} text-sm truncate max-w-xs">${currentUser}</span>
                        </div>
                    </nav>
                `;
            }

            renderMenu() {
                const { darkMode, currentPage } = this.state;
                return `
                    <div class="fixed top-0 left-0 w-64 h-full z-50 animate-slide-in-left shadow-2xl ${darkMode ? 'bg-gray-900 border-r border-gray-800' : 'bg-white border-r border-gray-200'}">
                        <div class="p-6">
                            <button id="menuClose" class="mb-6 p-2 rounded-lg ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600'}">‚úï</button>
                            <div class="space-y-4">
                                <button id="navMain" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${currentPage === 'main' ? (darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900') : (darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100')}">
                                    üè† ${this.t.mainPage}
                                </button>
                                <button id="navSettings" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${currentPage === 'settings' ? (darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900') : (darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100')}">
                                    ‚öôÔ∏è ${this.t.settings}
                                </button>
                                <button id="logoutBtn" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${darkMode ? 'text-red-400 hover:bg-gray-800' : 'text-red-600 hover:bg-gray-100'}">
                                    üö™ ${this.t.logout}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderMain() {
                const { darkMode } = this.state;
                const total = this.getTotalBalance();
                const stats = this.getCategoryStats();
                const filtered = this.getFilteredEntries();

                return `
                    <div class="min-h-screen ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        ${this.renderNav()}
                        ${this.state.menuOpen ? this.renderMenu() : ''}
                        
                        <main class="max-w-7xl mx-auto px-6 py-8">
                            <div class="p-8 rounded-2xl shadow-2xl mb-8 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.totalBalance}</h2>
                                    <div class="animate-bounce">${total >= 0 ? 'üìà' : 'üìâ'}</div>
                                </div>
                                <p class="text-5xl font-bold mb-2 ${total >= 0 ? 'text-green-500' : 'text-red-500'}">${total.toFixed(2)} ‚Ç¨</p>
                                <p class="text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.state.entries.length} ${this.t.entries}</p>
                            </div>

                            ${this.getChartData().length > 0 ? `
                                <div class="p-8 rounded-2xl shadow-2xl mb-8 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                    <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.history}</h2>
                                    <div style="height: 300px;"><canvas id="chart"></canvas></div>
                                </div>
                            ` : ''}

                            <div class="p-8 rounded-2xl shadow-2xl mb-8 ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.categories}</h2>
                                    <button id="newCatBtn" ${this.state.isSaving ? 'disabled' : ''} class="px-4 py-2 rounded-xl font-semibold hover-grow button-press ${this.state.isSaving ? 'bg-gray-500 text-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'}">
                                        ${this.state.isSaving ? '‚è≥' : '‚ûï'} ${this.t.newCategory}
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    ${this.state.categories.length === 0 ? `<p class="col-span-full text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}">Erstelle deine erste Kategorie!</p>` : this.state.categories.map(cat => `
                                        <div class="relative group stagger-item">
                                            <button data-cat="${cat}" class="w-full p-4 rounded-xl hover-lift button-press ${this.state.selectedCategory === cat ? (darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white') : (darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-gray-900')}">
                                                <div class="text-sm mb-1">${cat}</div>
                                                ${stats[cat] ? `
                                                    <div class="text-lg font-bold ${stats[cat].total >= 0 ? 'text-green-500' : 'text-red-500'}">${stats[cat].total >= 0 ? '+' : ''}${stats[cat].total.toFixed(2)} ‚Ç¨</div>
                                                    <div class="text-xs opacity-75">${stats[cat].count} ${this.t.entries}</div>
                                                ` : ''}
                                            </button>
                                            <button data-delcat="${cat}" class="absolute top-2 right-2 p-1 rounded bg-red-500 text-white opacity-0 group-hover:opacity-100 hover-grow text-xs">üóëÔ∏è</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="p-8 rounded-2xl shadow-2xl ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                                    <h2 class="text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}">${this.state.selectedCategory ? `${this.state.selectedCategory} - ${this.t.history}` : this.t.history}</h2>
                                    <div class="flex gap-3">
                                        ${this.state.selectedCategory ? `<button id="clearFilter" class="text-sm px-3 py-1 rounded-lg ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}">${this.t.showAll}</button>` : ''}
                                        <button id="newEntryBtn" ${this.state.categories.length === 0 || this.state.isSaving ? 'disabled' : ''} class="px-4 py-2 rounded-xl font-semibold hover-grow button-press ${this.state.categories.length === 0 || this.state.isSaving ? 'bg-gray-500 text-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'}">
                                            ${this.state.isSaving ? '‚è≥' : '‚ûï'} ${this.t.addEntry}
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${filtered.length === 0 ? `<p class="text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.noEntries}</p>` : filtered.slice().reverse().map(e => `
                                        <div class="p-4 rounded-xl hover-lift cursor-pointer ${darkMode ? 'bg-gray-800' : 'bg-white/50'}">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <span class="text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-700'}">${e.category}</span>
                                                    </div>
                                                    <p class="font-medium ${darkMode ? 'text-white' : 'text-gray-900'}">${e.description}</p>
                                                    <p class="text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${e.date}</p>
                                                </div>
                                                <p class="text-xl font-bold ${e.amount >= 0 ? 'text-green-500' : 'text-red-500'}">${e.amount >= 0 ? '+' : ''}${parseFloat(e.amount).toFixed(2)} ‚Ç¨</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </main>

                        ${this.state.showCategoryModal ? this.renderCategoryModal() : ''}
                        ${this.state.showAddModal ? this.renderAddModal() : ''}
                    </div>
                `;
            }

            renderCategoryModal() {
                const { darkMode } = this.state;
                return `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
                        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl animate-scale-in ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-purple-200'}">
                            <h2 class="text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.newCategory}</h2>
                            <div class="space-y-6">
                                <input type="text" id="newCatName" placeholder="${this.t.categoryName}" class="w-full px-4 py-3 rounded-xl input-focus outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}" />
                                <div class="flex gap-3">
                                    <button id="cancelCat" class="flex-1 py-3 rounded-xl font-semibold button-press ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-900'}">${this.t.cancel}</button>
                                    <button id="saveCat" ${this.state.isSaving ? 'disabled' : ''} class="flex-1 py-3 rounded-xl font-semibold button-press ${this.state.isSaving ? 'bg-gray-500 text-gray-300' : 'bg-blue-600 hover:bg-blue-700 text-white'}">
                                        ${this.state.isSaving ? this.t.loading : this.t.addCategory}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAddModal() {
                const { darkMode, type, categories } = this.state;
                return `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
                        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl animate-scale-in ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-purple-200'}">
                            <h2 class="text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.newEntry}</h2>
                            <div class="space-y-6">
                                <div>
                                    <div class="text-sm mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}">Typ</div>
                                    <div class="flex gap-3">
                                        <button id="typeIncome" class="flex-1 py-3 rounded-xl font-semibold button-press ${type === 'income' ? 'bg-green-600 text-white' : (darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600')}">${this.t.income}</button>
                                        <button id="typeExpense" class="flex-1 py-3 rounded-xl font-semibold button-press ${type === 'expense' ? 'bg-red-600 text-white' : (darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600')}">${this.t.expense}</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.category}</label>
                                    <select id="entryCat" class="w-full px-4 py-3 rounded-xl outline-none ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-900'}">
                                        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.amount} (‚Ç¨)</label>
                                    <input type="number" step="0.01" id="entryAmount" placeholder="0.00" class="w-full px-4 py-3 rounded-xl input-focus outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}" />
                                </div>
                                <div>
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.description}</label>
                                    <input type="text" id="entryDesc" placeholder="z.B. Display Reparatur" class="w-full px-4 py-3 rounded-xl input-focus outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}" />
                                </div>
                                <div class="flex gap-3 pt-4">
                                    <button id="cancelEntry" class="flex-1 py-3 rounded-xl font-semibold button-press ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-900'}">${this.t.cancel}</button>
                                    <button id="saveEntry" ${this.state.isSaving ? 'disabled' : ''} class="flex-1 py-3 rounded-xl font-semibold button-press ${this.state.isSaving ? 'bg-gray-500 text-gray-300' : 'bg-blue-600 hover:bg-blue-700 text-white'}">
                                        ${this.state.isSaving ? this.t.loading : this.t.save}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getTotalBalance() {
                return this.state.entries.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            }

            getChartData() {
                return this.state.entries.map((entry, index) => {
                    const runningTotal = this.state.entries.slice(0, index + 1).reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                    return { date: entry.date, balance: runningTotal };
                });
            }

            getCategoryStats() {
                const stats = {};
                this.state.entries.forEach(entry => {
                    if (!stats[entry.category]) {
                        stats[entry.category] = { total: 0, count: 0 };
                    }
                    stats[entry.category].total += parseFloat(entry.amount || 0);
                    stats[entry.category].count += 1;
                });
                return stats;
            }

            getFilteredEntries() {
                return this.state.selectedCategory 
                    ? this.state.entries.filter(e => e.category === this.state.selectedCategory)
                    : this.state.entries;
            }

            renderChart() {
                setTimeout(() => {
                    const canvas = document.getElementById('chart');
                    if (!canvas) return;
                    if (this.state.chart) this.state.chart.destroy();

                    const data = this.getChartData();
                    const ctx = canvas.getContext('2d');

                    this.state.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.date),
                            datasets: [{
                                label: this.t.totalBalance,
                                data: data.map(d => d.balance),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                pointBackgroundColor: data.map(d => d.balance >= 0 ? '#10b981' : '#ef4444'),
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: this.state.darkMode ? '#111827' : '#ffffff',
                                    titleColor: this.state.darkMode ? '#fff' : '#000',
                                    bodyColor: this.state.darkMode ? '#fff' : '#000',
                                    borderColor: this.state.darkMode ? '#374151' : '#a855f7',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: false,
                                    callbacks: { label: (ctx) => `${ctx.parsed.y.toFixed(2)} ‚Ç¨` }
                                }
                            },
                            scales: {
                                y: {
                                    grid: { color: this.state.darkMode ? '#1f2937' : '#e5e7eb' },
                                    ticks: {
                                        color: this.state.darkMode ? '#6b7280' : '#6b7280',
                                        callback: (val) => `${val} ‚Ç¨`
                                    }
                                },
                                x: {
                                    grid: { color: this.state.darkMode ? '#1f2937' : '#e5e7eb' },
                                    ticks: { color: this.state.darkMode ? '#6b7280' : '#6b7280' }
                                }
                            },
                            animation: { duration: 1000, easing: 'easeInOutQuart' }
                        }
                    });
                }, 100);
            }

            attachEvents() {
                const discordLoginBtn = document.getElementById('discordLoginBtn');
                if (discordLoginBtn) {
                    discordLoginBtn.onclick = () => this.loginWithDiscord();
                }

                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.onclick = () => {
                        this.state.darkMode = !this.state.darkMode;
                        this.saveSettings();
                        this.render();
                    };
                }

                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.onclick = () => {
                        this.state.darkMode = !this.state.darkMode;
                        this.saveSettings();
                        this.render();
                    };
                }

                document.querySelectorAll('[data-lang]').forEach(btn => {
                    btn.onclick = () => {
                        this.state.language = btn.dataset.lang;
                        this.saveSettings();
                        this.render();
                    };
                });

                const menuToggle = document.getElementById('menuToggle');
                const menuClose = document.getElementById('menuClose');
                if (menuToggle) menuToggle.onclick = () => { this.state.menuOpen = true; this.render(); };
                if (menuClose) menuClose.onclick = () => { this.state.menuOpen = false; this.render(); };

                const navMain = document.getElementById('navMain');
                const navSettings = document.getElementById('navSettings');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (navMain) navMain.onclick = () => { this.state.currentPage = 'main'; this.state.menuOpen = false; this.render(); };
                if (navSettings) navSettings.onclick = () => { this.state.currentPage = 'settings'; this.state.menuOpen = false; this.render(); };
                if (logoutBtn) {
                    logoutBtn.onclick = async () => {
                        await supabaseClient.auth.signOut();
                        location.reload();
                    };
                }

                const newCatBtn = document.getElementById('newCatBtn');
                if (newCatBtn && !newCatBtn.disabled) {
                    newCatBtn.onclick = () => { 
                        this.state.showCategoryModal = true; 
                        this.render(); 
                    };
                }

                const cancelCat = document.getElementById('cancelCat');
                if (cancelCat) {
                    cancelCat.onclick = () => { 
                        this.state.showCategoryModal = false; 
                        this.render(); 
                    };
                }

                const saveCat = document.getElementById('saveCat');
                const newCatName = document.getElementById('newCatName');
                if (saveCat && newCatName && !saveCat.disabled) {
                    saveCat.onclick = async () => {
                        const catName = newCatName.value.trim();
                        if (!catName) return;
                        
                        // Pr√ºfe ob Kategorie bereits existiert
                        if (this.state.categories.includes(catName)) {
                            alert('Diese Kategorie existiert bereits!');
                            return;
                        }
                        
                        this.state.isSaving = true;
                        this.render();
                        
                        try {
                            // Versuche erst die Tabelle zu erstellen (falls sie nicht existiert)
                            const { data, error } = await supabaseClient.from('categories').insert([{ 
                                name: catName, 
                                user_id: this.state.userId 
                            }]).select();
                            
                            if (error) {
                                console.error('Supabase Error:', error);
                                
                                // Falls Tabelle nicht existiert, nutze lokalen Speicher
                                if (error.code === '42P01' || error.message.includes('does not exist')) {
                                    console.log('Tabelle existiert nicht, nutze lokalen Speicher');
                                    this.state.categories.push(catName);
                                    this.saveCategoriesToLocal();
                                    this.state.isSaving = false;
                                    this.state.showCategoryModal = false;
                                    this.render();
                                    return;
                                }
                                
                                alert('Fehler beim Speichern: ' + error.message);
                                this.state.isSaving = false;
                                this.render();
                                return;
                            }
                            
                            // F√ºge Kategorie sofort zum State hinzu
                            this.state.categories.push(catName);
                            
                            this.state.isSaving = false;
                            this.state.showCategoryModal = false;
                            this.state.newCategoryName = '';
                            this.render();
                        } catch (err) {
                            console.error('Catch Error:', err);
                            alert('Fehler: ' + err.message);
                            this.state.isSaving = false;
                            this.render();
                        }
                    };
                }

                document.querySelectorAll('[data-cat]').forEach(btn => {
                    btn.onclick = () => {
                        const cat = btn.dataset.cat;
                        this.state.selectedCategory = this.state.selectedCategory === cat ? null : cat;
                        this.render();
                    };
                });

                document.querySelectorAll('[data-delcat]').forEach(btn => {
                    btn.onclick = async (e) => {
                        e.stopPropagation();
                        
                        this.state.isSaving = true;
                        this.render();
                        
                        const catName = btn.dataset.delcat;
                        await supabaseClient.from('categories').delete().eq('name', catName).eq('user_id', this.state.userId);
                        
                        await this.loadUserData(this.state.userId);
                        
                        this.state.isSaving = false;
                        this.render();
                    };
                });

                const clearFilter = document.getElementById('clearFilter');
                if (clearFilter) clearFilter.onclick = () => { this.state.selectedCategory = null; this.render(); };

                const newEntryBtn = document.getElementById('newEntryBtn');
                if (newEntryBtn && !newEntryBtn.disabled) {
                    newEntryBtn.onclick = () => {
                        this.state.category = this.state.categories[0] || '';
                        this.state.showAddModal = true;
                        this.render();
                    };
                }

                const typeIncome = document.getElementById('typeIncome');
                const typeExpense = document.getElementById('typeExpense');
                if (typeIncome) typeIncome.onclick = () => { this.state.type = 'income'; this.render(); };
                if (typeExpense) typeExpense.onclick = () => { this.state.type = 'expense'; this.render(); };

                const cancelEntry = document.getElementById('cancelEntry');
                if (cancelEntry) {
                    cancelEntry.onclick = () => { 
                        this.state.showAddModal = false; 
                        this.render(); 
                    };
                }

                const saveEntry = document.getElementById('saveEntry');
                const entryAmount = document.getElementById('entryAmount');
                const entryDesc = document.getElementById('entryDesc');
                const entryCat = document.getElementById('entryCat');
                
                if (saveEntry && entryAmount && entryDesc && entryCat && !saveEntry.disabled) {
                    saveEntry.onclick = async () => {
                        if (!entryAmount.value || !entryDesc.value) return;
                        
                        this.state.isSaving = true;
                        this.render();
                        
                        const newEntry = {
                            user_id: this.state.userId,
                            amount: this.state.type === 'expense' ? -Math.abs(parseFloat(entryAmount.value)) : Math.abs(parseFloat(entryAmount.value)),
                            description: entryDesc.value,
                            category: entryCat.value,
                            type: this.state.type,
                            date: new Date().toLocaleDateString(this.state.language === 'de' ? 'de-DE' : this.state.language === 'fr' ? 'fr-FR' : 'en-US'),
                            timestamp: Date.now()
                        };

                        await supabaseClient.from('entries').insert([newEntry]);
                        
                        await this.loadUserData(this.state.userId);
                        
                        this.state.isSaving = false;
                        this.state.showAddModal = false;
                        this.render();
                    };
                }
            }
        }

        new App();
    </script>
</body>
</html>
