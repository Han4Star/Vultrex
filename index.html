<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handy-Reparaturen Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
  h1 { text-align: center; }
  #endstand { font-size: 2em; margin: 20px 0; text-align: center; }
  .categories { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
  .category-btn { padding: 10px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
  .category-btn:hover { background: #2980b9; }
  #popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
           background: white; border: 2px solid #333; padding: 20px; z-index: 1000; max-height: 70%; overflow-y: auto; width: 90%; max-width: 500px; }
  #popup h2 { margin-top: 0; }
  #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.5); z-index: 999; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 8px; text-align: left; }
  .income { color: green; }
  .expense { color: red; }
  canvas { background: white; border: 1px solid #ccc; border-radius: 5px; }
</style>
</head>
<body>

<h1>Handy-Reparaturen Dashboard</h1>
<div id="endstand">Gesamt: 0 €</div>

<div class="categories" id="categories"></div>

<canvas id="chart" width="400" height="200"></canvas>

<div id="overlay"></div>
<div id="popup">
  <h2 id="popup-title"></h2>
  <table id="popup-table">
    <thead><tr><th>Datum</th><th>Kategorie</th><th>Betrag</th></tr></thead>
    <tbody></tbody>
  </table>
  <button onclick="closePopup()">Schließen</button>
</div>

<script>
// ==== CONFIG ====
// Dein Google Sheet CSV Link (veröffentlicht)
const sheetUrl = 'https://docs.google.com/spreadsheets/u/0/d/1D8z1RFsxaYiBSwpIfT0ni4dI6iYALuOo0KjsJ9uamNI/htmlview#gid=1552836807'; // <-- Hier deinen veröffentlichten Google Sheet CSV Link einfügen

// ==== GLOBALS ====
let transactions = [];

// ==== FETCH DATA ====
async function loadData() {
    const res = await fetch(sheetUrl);
    const text = await res.text();
    parseCSV(text);
    renderDashboard();
    renderChart();
}

// ==== CSV PARSER ====
function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    const headers = lines[0].split(',');
    transactions = lines.slice(1).map(line => {
        const cols = line.split(',');
        let obj = {};
        headers.forEach((h, i) => { obj[h.trim()] = cols[i]; });
        // Preis als Zahl
        obj.Preis = parseFloat(obj.Preis) || 0;
        return obj;
    });
}

// ==== DASHBOARD ====
function renderDashboard() {
    const endstand = transactions.reduce((sum, t) => sum + t.Preis, 0);
    document.getElementById('endstand').innerText = `Gesamt: ${endstand.toFixed(2)} €`;

    // Kategorien / Produkte als Buttons
    const categoryDiv = document.getElementById('categories');
    categoryDiv.innerHTML = '';
    const products = [...new Set(transactions.map(t => t.Kategorie))];
    products.forEach(prod => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.innerText = prod;
        btn.onclick = () => showPopup(prod);
        categoryDiv.appendChild(btn);
    });
}

// ==== POPUP ====
function showPopup(product) {
    document.getElementById('popup-title').innerText = product;
    const tbody = document.querySelector('#popup-table tbody');
    tbody.innerHTML = '';
    transactions.filter(t => t.Kategorie === product).forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.Datum || '-'}</td>
                        <td>${t.Kategorie}</td>
                        <td class="${t.Preis >= 0 ? 'income' : 'expense'}">${t.Preis.toFixed(2)} €</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('popup').style.display = 'block';
}

function closePopup() {
    document.getElementById('popup').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
}

// ==== CHART.JS ====
function renderChart() {
    const ctx = document.getElementById('chart').getContext('2d');
    const labels = transactions.map((t,i) => t.Datum || `T${i+1}`);
    const data = transactions.map(t => t.Preis);
    new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'Preis (€)', data: data, borderColor: 'blue', backgroundColor: 'rgba(0,0,255,0.2)' }] },
        options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });
}

// ==== INIT ====
loadData();
</script>

</body>
</html>
