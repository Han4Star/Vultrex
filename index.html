<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Repair Business Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-in-left { animation: slideInLeft 0.4s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .hover-grow { transition: all 0.3s ease; }
        .hover-grow:hover { transform: scale(1.05); }
        
        .button-press:active { transform: scale(0.95); }
        
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { transform: scale(1.02); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        
        .stagger-item { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
        .stagger-item:nth-child(1) { animation-delay: 0.1s; }
        .stagger-item:nth-child(2) { animation-delay: 0.2s; }
        .stagger-item:nth-child(3) { animation-delay: 0.3s; }
        .stagger-item:nth-child(4) { animation-delay: 0.4s; }
        .stagger-item:nth-child(5) { animation-delay: 0.5s; }
        .stagger-item:nth-child(6) { animation-delay: 0.6s; }
        .stagger-item:nth-child(7) { animation-delay: 0.7s; }
        .stagger-item:nth-child(8) { animation-delay: 0.8s; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Supabase Konfiguration
        const SUPABASE_URL = 'https://jpwnhsblrmizqwvwnfsb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd25oc2Jscm1penF3dnduZnNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5OTE0NTYsImV4cCI6MjA4MzU2NzQ1Nn0.03F1ppRXNf9upk3tI4W84EQH8pNMmQCdbEPxsNixcuY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const translations = {
            de: {
                login: 'Anmelden', username: 'Email', password: 'Passwort', loading: 'L√§dt...',
                logout: 'Abmelden', totalBalance: 'Gesamtbilanz', entries: 'Eintr√§ge', history: 'Verlauf',
                categories: 'Kategorien', addEntry: 'Eintrag', newEntry: 'Neuer Eintrag',
                income: 'Einnahme', expense: 'Ausgabe', category: 'Kategorie', amount: 'Betrag',
                description: 'Beschreibung', cancel: 'Abbrechen', save: 'Speichern',
                noEntries: 'Keine Eintr√§ge vorhanden', showAll: 'Alle anzeigen',
                settings: 'Einstellungen', language: 'Sprache', theme: 'Design',
                darkMode: 'Dark Mode', lightMode: 'Light Mode', mainPage: 'Hauptseite',
                newCategory: 'Neue Kategorie', categoryName: 'Kategoriename',
                addCategory: 'Kategorie hinzuf√ºgen', deleteCategory: 'L√∂schen',
                register: 'Registrieren', noAccount: 'Noch kein Account?', haveAccount: 'Bereits registriert?'
            },
            en: {
                login: 'Login', username: 'Email', password: 'Password', loading: 'Loading...',
                logout: 'Logout', totalBalance: 'Total Balance', entries: 'Entries', history: 'History',
                categories: 'Categories', addEntry: 'Entry', newEntry: 'New Entry',
                income: 'Income', expense: 'Expense', category: 'Category', amount: 'Amount',
                description: 'Description', cancel: 'Cancel', save: 'Save',
                noEntries: 'No entries available', showAll: 'Show all',
                settings: 'Settings', language: 'Language', theme: 'Theme',
                darkMode: 'Dark Mode', lightMode: 'Light Mode', mainPage: 'Main Page',
                newCategory: 'New Category', categoryName: 'Category Name',
                addCategory: 'Add Category', deleteCategory: 'Delete',
                register: 'Register', noAccount: 'No account yet?', haveAccount: 'Already registered?'
            },
            fr: {
                login: 'Connexion', username: 'Email', password: 'Mot de passe', loading: 'Chargement...',
                logout: 'D√©connexion', totalBalance: 'Solde Total', entries: 'Entr√©es', history: 'Historique',
                categories: 'Cat√©gories', addEntry: 'Entr√©e', newEntry: 'Nouvelle Entr√©e',
                income: 'Revenu', expense: 'D√©pense', category: 'Cat√©gorie', amount: 'Montant',
                description: 'Description', cancel: 'Annuler', save: 'Enregistrer',
                noEntries: 'Aucune entr√©e disponible', showAll: 'Tout afficher',
                settings: 'Param√®tres', language: 'Langue', theme: 'Th√®me',
                darkMode: 'Mode Sombre', lightMode: 'Mode Clair', mainPage: 'Page Principale',
                newCategory: 'Nouvelle Cat√©gorie', categoryName: 'Nom de la cat√©gorie',
                addCategory: 'Ajouter une cat√©gorie', deleteCategory: 'Supprimer',
                register: 'S\'inscrire', noAccount: 'Pas encore de compte?', haveAccount: 'D√©j√† inscrit?'
            }
        };

        class App {
            constructor() {
                this.state = {
                    darkMode: true,
                    language: 'de',
                    isLoggedIn: false,
                    isRegistering: false,
                    username: '',
                    password: '',
                    entries: [],
                    categories: [],
                    showAddModal: false,
                    showCategoryModal: false,
                    amount: '',
                    description: '',
                    category: '',
                    newCategoryName: '',
                    type: 'income',
                    loading: false,
                    currentUser: '',
                    userId: null,
                    selectedCategory: null,
                    menuOpen: false,
                    currentPage: 'main',
                    chart: null
                };
                this.init();
            }

            get t() { return translations[this.state.language]; }

            async init() {
                await this.checkAuth();
                this.render();
            }

            async checkAuth() {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    this.state.isLoggedIn = true;
                    this.state.userId = session.user.id;
                    this.state.currentUser = session.user.email;
                    await this.loadUserData();
                }
            }

            async loadUserData() {
                const { data: settings } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('user_id', this.state.userId)
                    .single();
                
                if (settings) {
                    this.state.darkMode = settings.dark_mode ?? true;
                    this.state.language = settings.language ?? 'de';
                }

                const { data: categories } = await supabase
                    .from('categories')
                    .select('name')
                    .eq('user_id', this.state.userId);
                
                if (categories) {
                    this.state.categories = categories.map(c => c.name);
                }

                const { data: entries } = await supabase
                    .from('entries')
                    .select('*')
                    .eq('user_id', this.state.userId)
                    .order('timestamp', { ascending: true });
                
                if (entries) {
                    this.state.entries = entries;
                }
            }

            async saveSettings() {
                if (!this.state.userId) return;
                
                await supabase
                    .from('settings')
                    .upsert({
                        user_id: this.state.userId,
                        dark_mode: this.state.darkMode,
                        language: this.state.language
                    });
            }

            async handleAuth(isLogin) {
                this.state.loading = true;
                this.render();

                try {
                    if (isLogin) {
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email: this.state.username,
                            password: this.state.password
                        });

                        if (error) throw error;

                        this.state.isLoggedIn = true;
                        this.state.userId = data.user.id;
                        this.state.currentUser = data.user.email;
                        await this.loadUserData();
                    } else {
                        const { data, error } = await supabase.auth.signUp({
                            email: this.state.username,
                            password: this.state.password
                        });

                        if (error) throw error;

                        if (data.user) {
                            this.state.userId = data.user.id;
                            await supabase.from('settings').insert({
                                user_id: data.user.id,
                                dark_mode: true,
                                language: 'de'
                            });
                        }

                        alert('Account erstellt! Bitte melde dich jetzt an.');
                        this.state.isRegistering = false;
                    }
                } catch (error) {
                    alert(error.message);
                }

                this.state.loading = false;
                this.render();
            }

            async handleLogout() {
                await supabase.auth.signOut();
                this.state.isLoggedIn = false;
                this.state.currentUser = '';
                this.state.userId = null;
                this.state.entries = [];
                this.state.categories = [];
                this.state.menuOpen = false;
                this.render();
            }

            async addCategory(name) {
                const { error } = await supabase
                    .from('categories')
                    .insert({
                        user_id: this.state.userId,
                        name: name
                    });

                if (!error) {
                    this.state.categories.push(name);
                }
            }

            async deleteCategory(name) {
                await supabase
                    .from('categories')
                    .delete()
                    .eq('user_id', this.state.userId)
                    .eq('name', name);

                this.state.categories = this.state.categories.filter(c => c !== name);
            }

            async addEntry(entry) {
                const { data, error } = await supabase
                    .from('entries')
                    .insert({
                        ...entry,
                        user_id: this.state.userId
                    })
                    .select()
                    .single();

                if (!error && data) {
                    this.state.entries.push(data);
                }
            }

            render() {
                const app = document.getElementById('app');
                if (!this.state.isLoggedIn) {
                    app.innerHTML = this.renderLogin();
                } else if (this.state.currentPage === 'settings') {
                    app.innerHTML = this.renderSettings();
                } else {
                    app.innerHTML = this.renderMain();
                    if (this.getChartData().length > 0) this.renderChart();
                }
                this.attachEvents();
            }

            renderLogin() {
                const { darkMode, isRegistering } = this.state;
                return `
                    <div class="min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl hover-lift animate-scale-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                            <div class="text-center mb-8">
                                <h1 class="text-4xl font-bold mb-2 animate-pulse-slow ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}">
                                    Phone Repair
                                </h1>
                                <p class="${darkMode ? 'text-gray-400' : 'text-gray-600'}">Business Tracker</p>
                            </div>
                            
                            <div class="space-y-6">
                                <input type="email" id="username" placeholder="${this.t.username}" 
                                    class="w-full px-4 py-3 rounded-xl input-focus outline-none stagger-item ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-white text-gray-900 placeholder-gray-500'}" />
                                
                                <input type="password" id="password" placeholder="${this.t.password}" 
                                    class="w-full px-4 py-3 rounded-xl input-focus outline-none stagger-item ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-white text-gray-900 placeholder-gray-500'}" />
                                
                                <button id="authBtn" class="w-full py-3 rounded-xl font-semibold button-press stagger-item ${darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white animate-glow' : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'}">
                                    ${this.state.loading ? this.t.loading : (isRegistering ? this.t.register : this.t.login)}
                                </button>

                                <button id="toggleAuth" class="w-full text-sm ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'}">
                                    ${isRegistering ? this.t.haveAccount : this.t.noAccount}
                                </button>
                            </div>
                        </div>
                        
                        <button id="themeToggle" class="fixed top-8 right-8 p-3 rounded-full hover-grow shadow-lg ${darkMode ? 'bg-gray-800 text-yellow-400' : 'bg-white text-gray-900'}">
                            ${darkMode ? '‚òÄÔ∏è' : 'üåô'}
                        </button>
                    </div>
                `;
            }

            renderSettings() {
                const { darkMode, language } = this.state;
                return `
                    <div class="min-h-screen ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        ${this.renderNav()}
                        ${this.state.menuOpen ? this.renderMenu() : ''}
                        
                        <main class="max-w-3xl mx-auto px-6 py-8">
                            <div class="p-8 rounded-2xl shadow-2xl mb-6 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.theme}</h2>
                                <div class="flex items-center justify-between">
                                    <span class="${darkMode ? 'text-gray-300' : 'text-gray-700'}">${darkMode ? this.t.darkMode : this.t.lightMode}</span>
                                    <button id="darkModeToggle" class="relative w-16 h-8 rounded-full hover-grow ${darkMode ? 'bg-blue-600' : 'bg-gray-300'}">
                                        <div class="absolute top-1 left-1 w-6 h-6 rounded-full bg-white transition-transform duration-300 ${darkMode ? 'translate-x-8' : ''} flex items-center justify-center text-sm">
                                            ${darkMode ? 'üåô' : '‚òÄÔ∏è'}
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <div class="p-8 rounded-2xl shadow-2xl hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.language}</h2>
                                <div class="space-y-4">
                                    ${['de', 'en', 'fr'].map(lang => `
                                        <button data-lang="${lang}" class="w-full px-4 py-3 rounded-xl font-semibold hover-grow button-press ${language === lang ? (darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white') : (darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-100 text-gray-700')}">
                                            ${lang === 'de' ? 'Deutsch' : lang === 'en' ? 'English' : 'Fran√ßais'}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </main>
                    </div>
                `;
            }

            renderNav() {
                const { darkMode, currentUser } = this.state;
                return `
                    <nav class="border-b ${darkMode ? 'bg-gray-900/90 border-gray-800' : 'bg-white/70 border-purple-200'}">
                        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <button id="menuToggle" class="p-2 rounded-lg hover-grow ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900'}">‚ò∞</button>
                                <h1 class="text-2xl font-bold ${darkMode ? 'text-white' : 'bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent'}">Phone Repair Tracker</h1>
                            </div>
                            <span class="${darkMode ? 'text-gray-300' : 'text-gray-700'}">${currentUser}</span>
                        </div>
                    </nav>
                `;
            }

            renderMenu() {
                const { darkMode, currentPage } = this.state;
                return `
                    <div class="fixed top-0 left-0 w-64 h-full z-50 animate-slide-in-left shadow-2xl ${darkMode ? 'bg-gray-900 border-r border-gray-800' : 'bg-white border-r border-gray-200'}">
                        <div class="p-6">
                            <button id="menuClose" class="mb-6 p-2 rounded-lg ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600'}">‚úï</button>
                            <div class="space-y-4">
                                <button id="navMain" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${currentPage === 'main' ? (darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900') : (darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100')}">
                                    üè† ${this.t.mainPage}
                                </button>
                                <button id="navSettings" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${currentPage === 'settings' ? (darkMode ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-900') : (darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100')}">
                                    ‚öôÔ∏è ${this.t.settings}
                                </button>
                                <button id="logoutBtn" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg ${darkMode ? 'text-red-400 hover:bg-gray-800' : 'text-red-600 hover:bg-gray-100'}">
                                    üö™ ${this.t.logout}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderMain() {
                const { darkMode } = this.state;
                const total = this.getTotalBalance();
                const stats = this.getCategoryStats();
                const filtered = this.getFilteredEntries();

                return `
                    <div class="min-h-screen ${darkMode ? 'bg-gray-950' : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50'}">
                        ${this.renderNav()}
                        ${this.state.menuOpen ? this.renderMenu() : ''}
                        
                        <main class="max-w-7xl mx-auto px-6 py-8">
                            <div class="p-8 rounded-2xl shadow-2xl mb-8 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.totalBalance}</h2>
                                    <div class="animate-bounce">${total >= 0 ? 'üìà' : 'üìâ'}</div>
                                </div>
                                <p class="text-5xl font-bold mb-2 ${total >= 0 ? 'text-green-500' : 'text-red-500'}">${total.toFixed(2)} ‚Ç¨</p>
                                <p class="text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.state.entries.length} ${this.t.entries}</p>
                            </div>

                            ${this.getChartData().length > 0 ? `
                                <div class="p-8 rounded-2xl shadow-2xl mb-8 hover-lift animate-fade-in ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                    <h2 class="text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.history}</h2>
                                    <div style="height: 300px;"><canvas id="chart"></canvas></div>
                                </div>
                            ` : ''}

                            <div class="p-8 rounded-2xl shadow-2xl mb-8 ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.categories}</h2>
                                    <button id="newCatBtn" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold hover-grow button-press">‚ûï ${this.t.newCategory}</button>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    ${this.state.categories.map(cat => `
                                        <div class="relative group stagger-item">
                                            <button data-cat="${cat}" class="w-full p-4 rounded-xl hover-lift button-press ${this.state.selectedCategory === cat ? (darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white') : (darkMode ? 'bg-gray-800 text-gray-300' : 'bg-white text-gray-900')}">
                                                <div class="text-sm mb-1">${cat}</div>
                                                ${stats[cat] ? `
                                                    <div class="text-lg font-bold ${stats[cat].total >= 0 ? 'text-green-500' : 'text-red-500'}">${stats[cat].total >= 0 ? '+' : ''}${stats[cat].total.toFixed(2)} ‚Ç¨</div>
                                                    <div class="text-xs opacity-75">${stats[cat].count} ${this.t.entries}</div>
                                                ` : ''}
                                            </button>
                                            <button data-delcat="${cat}" class="absolute top-2 right-2 p-1 rounded bg-red-500 text-white opacity-0 group-hover:opacity-100 hover-grow">üóëÔ∏è</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="p-8 rounded-2xl shadow-2xl ${darkMode ? 'bg-gray-900/90 border border-gray-800' : 'bg-white/70 border border-purple-200'}">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}">${this.state.selectedCategory ? `${this.state.selectedCategory} - ${this.t.history}` : this.t.history}</h2>
                                    ${this.state.selectedCategory ? `<button id="clearFilter" class="text-sm px-3 py-1 rounded-lg ${darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}">${this.t.showAll}</button>` : ''}
                                    <button id="newEntryBtn" ${this.state.categories.length === 0 ? 'disabled' : ''} class="px-4 py-2 rounded-xl font-semibold hover-grow button-press ${this.state.categories.length === 0 ? 'bg-gray-500 text-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'}">‚ûï ${this.t.addEntry}</button>
                                </div>
                                <div class="space-y-3">
                                    ${filtered.length === 0 ? `<p class="text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.noEntries}</p>` : filtered.slice().reverse().map(e => `
                                        <div class="p-4 rounded-xl hover-lift cursor-pointer ${darkMode ? 'bg-gray-800' : 'bg-white/50'}">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <span class="text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-700'}">${e.category}</span>
                                                    </div>
                                                    <p class="font-medium ${darkMode ? 'text-white' : 'text-gray-900'}">${e.description}</p>
                                                    <p class="text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${e.date}</p>
                                                </div>
                                                <p class="text-xl font-bold ${parseFloat(e.amount) >= 0 ? 'text-green-500' : 'text-red-500'}">
                                                    ${parseFloat(e.amount) >= 0 ? '+' : ''}${parseFloat(e.amount).toFixed(2)} ‚Ç¨
                                                </p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </main>

                        ${this.state.showCategoryModal ? this.renderCategoryModal() : ''}
                        ${this.state.showAddModal ? this.renderAddModal() : ''}
                    </div>
                `;
            }

            renderCategoryModal() {
                const { darkMode } = this.state;
                return `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
                        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl animate-scale-in ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-purple-200'}">
                            <h2 class="text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.newCategory}</h2>
                            <div class="space-y-6">
                                <input type="text" id="newCatName" placeholder="${this.t.categoryName}" class="w-full px-4 py-3 rounded-xl input-focus outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}" />
                                <div class="flex gap-3">
                                    <button id="cancelCat" class="flex-1 py-3 rounded-xl font-semibold button-press ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-900'}">${this.t.cancel}</button>
                                    <button id="saveCat" class="flex-1 py-3 rounded-xl font-semibold bg-blue-600 hover:bg-blue-700 text-white button-press">${this.t.addCategory}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAddModal() {
                const { darkMode, type, categories } = this.state;
                return `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
                        <div class="w-full max-w-md p-8 rounded-2xl shadow-2xl animate-scale-in ${darkMode ? 'bg-gray-900 border border-gray-800' : 'bg-white border border-purple-200'}">
                            <h2 class="text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}">${this.t.newEntry}</h2>
                            <div class="space-y-6">
                                <div>
                                    <div class="text-sm mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}">Typ</div>
                                    <div class="flex gap-3">
                                        <button id="typeIncome" class="flex-1 py-3 rounded-xl font-semibold button-press ${type === 'income' ? 'bg-green-600 text-white' : (darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600')}">${this.t.income}</button>
                                        <button id="typeExpense" class="flex-1 py-3 rounded-xl font-semibold button-press ${type === 'expense' ? 'bg-red-600 text-white' : (darkMode ? 'bg-gray-800 text-gray-400' : 'bg-gray-200 text-gray-600')}">${this.t.expense}</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.category}</label>
                                    <select id="entryCat" class="w-full px-4 py-3 rounded-xl outline-none ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-900'}">
                                        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.amount} (‚Ç¨)</label>
                                    <input type="number" step="0.01" id="entryAmount" placeholder="0.00" class="w-full px-4 py-3 rounded-xl input-focus outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}" />
                                </div>
                                <div>
                                    <label class="text-sm mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-600'}">${this.t.description}</label>
                                    <input type="text" id="entryDesc" placeholder="z.B. Display Reparatur" class="w-full px-4 py-3 rounded-xl input-focus outline-none ${darkMode ? 'bg-gray-800 text-white placeholder-gray-500' : 'bg-gray-50 text-gray-900 placeholder-gray-500'}" />
                                </div>
                                <div class="flex gap-3 pt-4">
                                    <button id="cancelEntry" class="flex-1 py-3 rounded-xl font-semibold button-press ${darkMode ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-900'}">${this.t.cancel}</button>
                                    <button id="saveEntry" class="flex-1 py-3 rounded-xl font-semibold bg-blue-600 hover:bg-blue-700 text-white button-press">${this.t.save}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getTotalBalance() {
                return this.state.entries.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            }

            getChartData() {
                return this.state.entries.map((entry, index) => {
                    const runningTotal = this.state.entries.slice(0, index + 1).reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                    return { date: entry.date, balance: runningTotal };
                });
            }

            getCategoryStats() {
                const stats = {};
                this.state.entries.forEach(entry => {
                    if (!stats[entry.category]) {
                        stats[entry.category] = { total: 0, count: 0 };
                    }
                    stats[entry.category].total += parseFloat(entry.amount || 0);
                    stats[entry.category].count += 1;
                });
                return stats;
            }

            getFilteredEntries() {
                return this.state.selectedCategory 
                    ? this.state.entries.filter(e => e.category === this.state.selectedCategory)
                    : this.state.entries;
            }

            renderChart() {
                setTimeout(() => {
                    const canvas = document.getElementById('chart');
                    if (!canvas) return;
                    if (this.state.chart) this.state.chart.destroy();

                    const data = this.getChartData();
                    const ctx = canvas.getContext('2d');

                    this.state.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.date),
                            datasets: [{
                                label: this.t.totalBalance,
                                data: data.map(d => d.balance),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                pointBackgroundColor: data.map(d => d.balance >= 0 ? '#10b981' : '#ef4444'),
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: this.state.darkMode ? '#111827' : '#ffffff',
                                    titleColor: this.state.darkMode ? '#fff' : '#000',
                                    bodyColor: this.state.darkMode ? '#fff' : '#000',
                                    borderColor: this.state.darkMode ? '#374151' : '#a855f7',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: false,
                                    callbacks: { label: (ctx) => `${ctx.parsed.y.toFixed(2)} ‚Ç¨` }
                                }
                            },
                            scales: {
                                y: {
                                    grid: { color: this.state.darkMode ? '#1f2937' : '#e5e7eb' },
                                    ticks: {
                                        color: this.state.darkMode ? '#6b7280' : '#6b7280',
                                        callback: (val) => `${val} ‚Ç¨`
                                    }
                                },
                                x: {
                                    grid: { color: this.state.darkMode ? '#1f2937' : '#e5e7eb' },
                                    ticks: { color: this.state.darkMode ? '#6b7280' : '#6b7280' }
                                }
                            },
                            animation: { duration: 1000, easing: 'easeInOutQuart' }
                        }
                    });
                }, 100);
            }

            attachEvents() {
                const authBtn = document.getElementById('authBtn');
                const toggleAuth = document.getElementById('toggleAuth');
                const username = document.getElementById('username');
                const password = document.getElementById('password');
                
                if (authBtn && username && password) {
                    authBtn.onclick = () => {
                        this.state.username = username.value;
                        this.state.password = password.value;
                        this.handleAuth(!this.state.isRegistering);
                    };
                }

                if (toggleAuth) {
                    toggleAuth.onclick = () => {
                        this.state.isRegistering = !this.state.isRegistering;
                        this.render();
                    };
                }

                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.onclick = () => {
                        this.state.darkMode = !this.state.darkMode;
                        this.render();
                    };
                }

                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.onclick = async () => {
                        this.state.darkMode = !this.state.darkMode;
                        await this.saveSettings();
                        this.render();
                    };
                }

                document.querySelectorAll('[data-lang]').forEach(btn => {
                    btn.onclick = async () => {
                        this.state.language = btn.dataset.lang;
                        await this.saveSettings();
                        this.render();
                    };
                });

                const menuToggle = document.getElementById('menuToggle');
                const menuClose = document.getElementById('menuClose');
                if (menuToggle) menuToggle.onclick = () => { this.state.menuOpen = true; this.render(); };
                if (menuClose) menuClose.onclick = () => { this.state.menuOpen = false; this.render(); };

                const navMain = document.getElementById('navMain');
                const navSettings = document.getElementById('navSettings');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (navMain) navMain.onclick = () => { this.state.currentPage = 'main'; this.state.menuOpen = false; this.render(); };
                if (navSettings) navSettings.onclick = () => { this.state.currentPage = 'settings'; this.state.menuOpen = false; this.render(); };
                if (logoutBtn) logoutBtn.onclick = () => this.handleLogout();

                const newCatBtn = document.getElementById('newCatBtn');
                if (newCatBtn) newCatBtn.onclick = () => { this.state.showCategoryModal = true; this.render(); };

                const cancelCat = document.getElementById('cancelCat');
                if (cancelCat) cancelCat.onclick = () => { this.state.showCategoryModal = false; this.render(); };

                const saveCat = document.getElementById('saveCat');
                const newCatName = document.getElementById('newCatName');
                if (saveCat && newCatName) {
                    saveCat.onclick = async () => {
                        if (newCatName.value.trim()) {
                            await this.addCategory(newCatName.value.trim());
                            this.state.showCategoryModal = false;
                            this.render();
                        }
                    };
                }

                document.querySelectorAll('[data-cat]').forEach(btn => {
                    btn.onclick = () => {
                        const cat = btn.dataset.cat;
                        this.state.selectedCategory = this.state.selectedCategory === cat ? null : cat;
                        this.render();
                    };
                });

                document.querySelectorAll('[data-delcat]').forEach(btn => {
                    btn.onclick = async (e) => {
                        e.stopPropagation();
                        await this.deleteCategory(btn.dataset.delcat);
                        this.render();
                    };
                });

                const clearFilter = document.getElementById('clearFilter');
                if (clearFilter) clearFilter.onclick = () => { this.state.selectedCategory = null; this.render(); };

                const newEntryBtn = document.getElementById('newEntryBtn');
                if (newEntryBtn && !newEntryBtn.disabled) {
                    newEntryBtn.onclick = () => {
                        this.state.category = this.state.categories[0] || '';
                        this.state.showAddModal = true;
                        this.render();
                    };
                }

                const typeIncome = document.getElementById('typeIncome');
                const typeExpense = document.getElementById('typeExpense');
                if (typeIncome) typeIncome.onclick = () => { this.state.type = 'income'; this.render(); };
                if (typeExpense) typeExpense.onclick = () => { this.state.type = 'expense'; this.render(); };

                const cancelEntry = document.getElementById('cancelEntry');
                if (cancelEntry) cancelEntry.onclick = () => { this.state.showAddModal = false; this.render(); };

                const saveEntry = document.getElementById('saveEntry');
                const entryAmount = document.getElementById('entryAmount');
                const entryDesc = document.getElementById('entryDesc');
                const entryCat = document.getElementById('entryCat');
                
                if (saveEntry && entryAmount && entryDesc && entryCat) {
                    saveEntry.onclick = async () => {
                        if (!entryAmount.value || !entryDesc.value) return;
                        
                        const newEntry = {
                            id: Date.now(),
                            amount: this.state.type === 'expense' ? -Math.abs(parseFloat(entryAmount.value)) : Math.abs(parseFloat(entryAmount.value)),
                            description: entryDesc.value,
                            category: entryCat.value,
                            type: this.state.type,
                            date: new Date().toLocaleDateString(this.state.language === 'de' ? 'de-DE' : this.state.language === 'fr' ? 'fr-FR' : 'en-US'),
                            timestamp: Date.now()
                        };

                        await this.addEntry(newEntry);
                        this.state.showAddModal = false;
                        this.render();
                    };
                }
            }
        }

        new App();
    </script>
</body>
</html>
